<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>豊橋お買い物マップ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <style>
        body { font-family: sans-serif; background-color: #f8fafc; margin: 0; padding: 0; display: flex; justify-content: center; height: 100vh; }
        .app-container { width: 100%; max-width: 430px; background: white; position: relative; overflow: hidden; box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25); }
        
        /* ページ制御：地図を最優先に */
        .page { position: absolute; inset: 0; display: none; background: white; z-index: 10; padding-top: 110px; padding-bottom: 90px; }
        .page.active { display: block; }
        #map-page { padding: 0 !important; display: none; }
        #map-page.active { display: block; }
        #map { width: 100%; height: 100%; z-index: 1; }

        /* ヘッダー */
        header { position: absolute; top: 0; left: 0; right: 0; z-index: 5000; background: rgba(255,255,255,0.9); backdrop-filter: blur(8px); padding: 12px; border-bottom: 1px solid #e2e8f0; }
        .search-bar { display: flex; align-items: center; background: #f1f5f9; border-radius: 999px; padding: 4px 12px; border: 1px solid #e2e8f0; }
        .search-bar input { background: transparent; border: none; flex: 1; padding: 8px; outline: none; font-size: 14px; }
        .category-scroll { display: flex; gap: 8px; overflow-x: auto; padding: 8px 0 4px; scrollbar-width: none; }
        .category-scroll::-webkit-scrollbar { display: none; }
        .chip { padding: 6px 14px; border-radius: 999px; border: 1px solid #e2e8f0; background: white; font-size: 11px; font-weight: bold; white-space: nowrap; cursor: pointer; color: #64748b; }
        .chip.active { background: #0061A4; color: white; border-color: #0061A4; }

        /* ナビゲーション */
        nav { position: absolute; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-around; padding: 10px 0 25px; z-index: 5000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; background: none; border: none; color: #64748b; cursor: pointer; width: 33%; }
        .nav-item.active { color: #0061A4; font-weight: bold; }
        .nav-icon { height: 32px; width: 56px; border-radius: 16px; display: flex; align-items: center; justify-content: center; margin-bottom: 4px; }
        .nav-item.active .nav-icon { background: #dbeafe; }

        /* カードデザイン */
        .store-card { background: white; border: 1px solid #e2e8f0; border-radius: 16px; margin-bottom: 12px; overflow: hidden; }
        .price-tag { color: #dc2626; font-weight: bold; font-size: 14px; line-height: 1.6; }
        .no-wrap { display: inline-block; white-space: nowrap; }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <div class="search-bar">
            <span class="material-symbols-outlined" style="font-size: 20px; color: #94a3b8;">search</span>
            <input id="search-box" type="text" placeholder="店名や商品を検索" oninput="updateFilters()">
        </div>
        <div id="category-chips" class="category-scroll"></div>
    </header>

    <div id="map-page" class="page active">
        <div id="map"></div>
        <button onclick="goToMyLocation()" style="position: absolute; bottom: 100px; right: 16px; z-index: 1000; width: 50px; height: 50px; border-radius: 12px; background: white; border: 1px solid #e2e8f0; box-shadow: 0 4px 12px rgba(0,0,0,0.1); cursor: pointer;">
            <span class="material-symbols-outlined" style="color: #0061A4;">my_location</span>
        </button>
    </div>

    <div id="list-page" class="page" style="overflow-y: auto; padding-left: 16px; padding-right: 16px;">
        <div id="list-count" style="font-size: 12px; color: #64748b; margin-bottom: 10px; font-weight: bold;"></div>
        <div id="store-list-content"></div>
    </div>

    <div id="post-page" class="page" style="overflow-y: auto; padding: 120px 24px 100px;">
        <h2 style="font-size: 20px; font-weight: bold; margin-bottom: 20px;">価格を投稿</h2>
        <div style="display: flex; flex-direction: column; gap: 16px;">
            <div>
                <label style="font-size: 12px; color: #64748b; font-weight: bold; margin-left: 4px;">店舗名</label>
                <input id="post-store-name" style="width: 100%; padding: 12px; background: #f1f5f9; border: none; border-radius: 12px; margin-top: 4px;" placeholder="店名を入力">
            </div>
            <div>
                <label style="font-size: 12px; color: #64748b; font-weight: bold; margin-left: 4px;">商品名</label>
                <input id="post-item-name" style="width: 100%; padding: 12px; background: #f1f5f9; border: none; border-radius: 12px; margin-top: 4px;" placeholder="例：たまご">
            </div>
            <div>
                <label style="font-size: 12px; color: #64748b; font-weight: bold; margin-left: 4px;">価格 (税抜)</label>
                <input id="post-price" type="number" style="width: 100%; padding: 12px; background: #f1f5f9; border: none; border-radius: 12px; margin-top: 4px; font-size: 18px; font-weight: bold;" placeholder="198">
            </div>
            <div>
                <label style="font-size: 12px; color: #64748b; font-weight: bold; margin-left: 4px;">備考</label>
                <input id="post-note" style="width: 100%; padding: 12px; background: #f1f5f9; border: none; border-radius: 12px; margin-top: 4px;" placeholder="例：10個入">
            </div>
            <button id="submit-btn" onclick="submitData()" style="width: 100%; padding: 16px; background: #0061A4; color: white; font-weight: bold; border: none; border-radius: 999px; margin-top: 10px; box-shadow: 0 4px 12px rgba(0,97,164,0.3);">投稿する</button>
        </div>
    </div>

    <nav>
        <button id="btn-map" onclick="showPage('map-page', this)" class="nav-item active">
            <div class="nav-icon"><span class="material-symbols-outlined">map</span></div>
            <span style="font-size: 10px;">マップ</span>
        </button>
        <button id="btn-list" onclick="showPage('list-page', this)" class="nav-item">
            <div class="nav-icon"><span class="material-symbols-outlined">format_list_bulleted</span></div>
            <span style="font-size: 10px;">リスト</span>
        </button>
        <button id="btn-post" onclick="showPage('post-page', this)" class="nav-item">
            <div class="nav-icon"><span class="material-symbols-outlined">add_circle</span></div>
            <span style="font-size: 10px;">投稿</span>
        </button>
    </nav>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsb43W7oGI-uAyoWp19J1Z3WT3L48QW3TdJDIjseaTvLVtAMAfYX-sZNuLK6kuc2j2pbkLZ0I0p6Pp/pub?gid=0&single=true&output=csv';
    const gasUrl = 'https://script.google.com/macros/s/AKfycbz4OHWsfJStoowmEINpTMAXYEWu71AW5e5VDDyBCWTpAg5jznhgyouLjM5C3YEvUDo/exec';

    let map, markers = [], allStoreData = [], currentCategory = "すべて";

    function formatPrice(text) {
        if (!text) return "";
        return text.split('/').map(item => {
            const clean = item.trim();
            if (!clean) return "";
            return `<div style="border-bottom: 1px solid #f1f5f9; padding-bottom: 4px; margin-bottom: 4px;">${clean.replace(/([\(（].*?[\)）])/g, '<span class="no-wrap">$1</span>')}</div>`;
        }).join('');
    }

    function initMap() {
        if (map) map.remove();
        map = L.map('map', { zoomControl: false }).setView([34.7628, 137.3817], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        loadData();
    }

    async function loadData() {
        try {
            const res = await fetch(csvUrl + '&t=' + Date.now());
            const text = await res.text();
            const rows = text.split(/\r?\n/).slice(1);
            allStoreData = rows.map(row => {
                const c = row.split(',');
                return { name: c[0], lat: parseFloat(c[1]), lng: parseFloat(c[2]), category: c[5] || "未分類", price: c[6] || "" };
            }).filter(d => !isNaN(d.lat));
            render();
        } catch (e) { alert("データ読み込みエラー"); }
    }

    function render() {
        markers.forEach(m => map.removeLayer(m));
        markers = allStoreData.map(s => {
            const m = L.marker([s.lat, s.lng]).bindPopup(`<b>${s.name}</b><br><div style="color:red; font-weight:bold;">${formatPrice(s.price)}</div>`);
            m.storeData = s;
            return m;
        });
        const cats = ["すべて", ...new Set(allStoreData.map(d => d.category))];
        document.getElementById('category-chips').innerHTML = cats.map(c => `<div onclick="filter('${c}')" class="chip ${currentCategory === c ? 'active' : ''}">${c}</div>`).join('');
        updateFilters();
    }

    function filter(c) { currentCategory = c; render(); }

    function updateFilters() {
        const q = document.getElementById('search-box').value.toLowerCase();
        const container = document.getElementById('store-list-content');
        container.innerHTML = "";
        let count = 0;

        markers.forEach(m => {
            const s = m.storeData;
            const match = (s.name.toLowerCase().includes(q) || s.price.includes(q)) && (currentCategory === "すべて" || s.category === currentCategory);
            if (match) {
                map.addLayer(m);
                count++;
                container.innerHTML += `
                <div class="store-card">
                    <div style="padding: 12px; border-bottom: 1px solid #f1f5f9;">
                        <span style="font-size: 10px; background: #f1f5f9; padding: 2px 8px; border-radius: 4px; color: #64748b;">${s.category}</span>
                        <div style="font-weight: bold; margin-top: 4px;">${s.name}</div>
                    </div>
                    <div style="padding: 12px;" class="price-tag">${formatPrice(s.price)}</div>
                    <div style="padding: 12px; background: #f8fafc; display: flex; gap: 8px;">
                        <button onclick="map.flyTo([${s.lat},${s.lng}], 17); showPage('map-page', document.getElementById('btn-map'))" style="flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #e2e8f0; background: white; font-size: 12px; font-weight: bold; color: #0061A4;">地図を見る</button>
                        <button onclick="openPost('${s.name}')" style="flex: 1; padding: 8px; border-radius: 8px; background: #10b981; border: none; color: white; font-size: 12px; font-weight: bold;">投稿する</button>
                    </div>
                </div>`;
            } else { map.removeLayer(m); }
        });
        document.getElementById('list-count').innerText = `${count}件表示中`;
    }

    function showPage(id, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        btn.classList.add('active');
        if (id === 'map-page') { setTimeout(() => map.invalidateSize(), 200); }
    }

    function openPost(name) { document.getElementById('post-store-name').value = name; showPage('post-page', document.getElementById('btn-post')); }

    async function submitData() {
        const storeName = document.getElementById('post-store-name').value;
        const itemName = document.getElementById('post-item-name').value;
        const price = document.getElementById('post-price').value;
        const note = document.getElementById('post-note').value;
        if (!storeName || !itemName || !price) return alert("必須項目を入力してください");
        
        const b = document.getElementById('submit-btn');
        b.innerText = "送信中..."; b.disabled = true;
        try {
            await fetch(gasUrl, { method: "POST", mode: "no-cors", body: JSON.stringify({ storeName, itemName, price, note }) });
            alert("投稿しました！");
            loadData();
            showPage('map-page', document.getElementById('btn-map'));
        } catch (e) { alert("エラーが発生しました"); }
        b.innerText = "投稿する"; b.disabled = false;
    }

    function goToMyLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(p => map.flyTo([p.coords.latitude, p.coords.longitude], 16));
        }
    }

    window.onload = initMap;
</script>
</body>
</html>
