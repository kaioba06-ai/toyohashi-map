<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>è±Šæ©‹ãŠè²·ã„ç‰©ãƒãƒƒãƒ—</title>
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; background: #f8f9fa; overflow: hidden; }
        .page { display: none; height: calc(100vh - 65px); width: 100%; overflow-y: auto; }
        .active { display: block; }
        #map-page { height: calc(100vh - 65px); position: relative; }
        #map { height: 100%; width: 100%; z-index: 1; }
        #footer-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 65px;
            background: white; display: flex; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 5000;
        }
        .nav-item {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 11px; color: #666; cursor: pointer; border: none; background: none;
        }
        .nav-item.active-nav { color: #1a73e8; font-weight: bold; }
        .nav-icon { font-size: 24px; margin-bottom: 2px; }
        .list-container { padding: 15px; padding-bottom: 80px; }
        .store-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .store-name { font-weight: bold; font-size: 16px; color: #333; }
        .category-tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; color: white; margin: 5px 0; }
        #menu-container { position: absolute; top: 15px; right: 15px; z-index: 4000; }
        #menu-toggle { background: #1a73e8; color: white; border: none; border-radius: 8px; padding: 12px 18px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        #menu { position: absolute; top: 60px; right: 0; z-index: 4000; background: white; width: 240px; padding: 15px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.2); display: none; }
        #menu.show { display: block; }
        .route-btn { display: block; margin-top: 10px; padding: 12px; background: #1a73e8; color: white !important; text-align: center; text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 14px; }
        .location-btn { position: absolute; bottom: 20px; left: 20px; z-index: 1000; background: white; border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border: 2px solid #1a73e8; }
    </style>
</head>
<body>

<div id="map-page" class="page active">
    <div id="menu-container">
        <button id="menu-toggle" onclick="toggleMenu()">ğŸ” çµã‚Šè¾¼ã¿</button>
        <div id="menu">
            <input type="text" id="search-box" placeholder="åº—åæ¤œç´¢..." style="width:100%; padding:12px; border-radius:8px; border:2px solid #eee; box-sizing:border-box;">
            <div id="category-filters" style="margin-top:15px; max-height:250px; overflow-y:auto;"></div>
        </div>
    </div>
    <div id="map"></div>
    <div class="location-btn" onclick="goToMyLocation()">ğŸ“</div>
</div>

<div id="list-page" class="page">
    <div class="list-container">
        <h3>ğŸ“‹ åº—èˆ—ãƒ»åº•å€¤ä¸€è¦§</h3>
        <div id="store-list-content"></div>
    </div>
</div>

<div id="post-page" class="page">
    <div style="padding: 50px 30px; text-align: center;">
        <div style="font-size: 60px;">ğŸ’°</div>
        <h2>æŠ•ç¨¿ã§ãƒã‚¤ãƒ³ãƒˆGET!</h2>
        <p>æœ€æ–°ã®ä¾¡æ ¼æƒ…å ±ã‚’æŠ•ç¨¿ã—ã¦ã€åœ°åŸŸã®ãŠè²·ã„ç‰©ã‚’æ”¯ãˆã¾ã—ã‚‡ã†ã€‚</p>
        <button style="background:#1a73e8; color:white; border:none; padding:15px 30px; border-radius:30px; font-weight:bold; margin-top:20px;" onclick="showPage('map-page', document.querySelector('.nav-item'))">åœ°å›³ã¸æˆ»ã‚‹</button>
    </div>
</div>

<div id="footer-nav">
    <button class="nav-item active-nav" onclick="showPage('map-page', this)">
        <span class="nav-icon">ğŸ—ºï¸</span>åœ°å›³
    </button>
    <button class="nav-item" onclick="showPage('list-page', this)">
        <span class="nav-icon">ğŸ“‹</span>ä¸€è¦§
    </button>
    <button class="nav-item" onclick="showPage('post-page', this)">
        <span class="nav-icon">â•</span>æŠ•ç¨¿
    </button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ§˜ã”æç¤ºã®URL
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsb43W7oGI-uAyoWp19J1Z3WT3L48QW3TdJDIjseaTvLVtAMAfYX-sZNuLK6kuc2j2pbkLZ0I0p6Pp/pub?gid=0&single=true&output=csv';

    const categoryColors = {
        "ã‚¹ãƒ¼ãƒ‘ãƒ¼": "#ff4757", "æ¥­å‹™ã‚¹ãƒ¼ãƒ‘ãƒ¼": "#2f3542", "ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢": "#2ed573",
        "JA": "#ffa502", "ç›´è²©æ‰€": "#7bed9f", "å…«ç™¾å±‹": "#ff6348", "æœç‰©å±‹": "#eccc68",
        "é­šå±‹": "#1e90ff", "ãƒ–ãƒ©ã‚¸ãƒ«é£Ÿå“": "#3742fa", "ãƒ™ãƒˆãƒŠãƒ é£Ÿå“": "#ff7f50", "é£Ÿå“å€‰åº«": "#a4b0be"
    };

    let markers = [];
    const map = L.map('map', { zoomControl: false }).setView([34.7628, 137.3817], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // CSVè§£æï¼ˆãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰
    function csvToArray(str) {
        const result = [];
        const rows = str.split(/\r?\n/);
        rows.forEach(row => {
            const cols = [];
            let current = "";
            let inQuotes = false;
            for (let i = 0; i < row.length; i++) {
                const c = row[i];
                if (c === '"') inQuotes = !inQuotes;
                else if (c === ',' && !inQuotes) { cols.push(current); current = ""; }
                else current += c;
            }
            cols.push(current);
            result.push(cols);
        });
        return result;
    }

    async function loadData() {
        try {
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿ã®ãŸã‚ã«URLã«ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä»˜ä¸
            const response = await fetch(csvUrl + '&t=' + new Date().getTime());
            if (!response.ok) throw new Error("Googleã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ");
            
            const csvText = await response.text();
            const data = csvToArray(csvText.trim());
            const rows = data.slice(1); // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—

            const listContent = document.getElementById('store-list-content');
            listContent.innerHTML = '';
            const categories = new Set();

            rows.forEach((cols, index) => {
                // name, lat, lng, info1, info2, category, price
                if (cols.length < 3) return;

                const name = cols[0] ? cols[0].replace(/"/g, "").trim() : "åº—èˆ—åãªã—";
                const lat = parseFloat(cols[1]);
                const lng = parseFloat(cols[2]);
                const info1 = cols[3] || "";
                const info2 = cols[4] || "";
                const category = (cols[5] || "æœªåˆ†é¡").trim();
                const price = cols[6] || "";

                if (isNaN(lat) || isNaN(lng)) return;

                const color = categoryColors[category] || "#747d8c";
                categories.add(category);

                const marker = L.circleMarker([lat, lng], {
                    radius: 15, fillColor: color, color: "#fff", weight: 3, fillOpacity: 0.9
                });
                
                const priceHtml = price ? `<div style="margin-top:8px; padding:10px; background:#fffdf0; border-radius:6px; font-size:13px; border:1px solid #ffeaa7;">${price.split('/').join('<br>')}</div>` : "";
                const popupContent = `
                    <div style="min-width:180px;">
                        <strong style="font-size:15px;">${name}</strong><br>
                        <span style="font-size:12px; color:#666;">${info1} ${info2}</span>
                        ${priceHtml}
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank" class="route-btn">ğŸš— ã“ã“ã¸è¡Œã</a>
                    </div>`;
                
                marker.bindPopup(popupContent);
                marker.myCategory = category;
                marker.myName = name;
                marker.addTo(map);
                markers.push(marker);

                const card = document.createElement('div');
                card.className = 'store-card';
                card.innerHTML = `
                    <div class="store-name">${name}</div>
                    <div class="category-tag" style="background:${color}">${category}</div>
                    <div style="font-size:12px; color:#666;">${info1}</div>
                    <div style="margin-top:8px; font-size:13px; color:#d63031; font-weight:bold;">${price || ""}</div>
                `;
                listContent.appendChild(card);
            });

            setupFilters(Array.from(categories));

        } catch (e) {
            console.error(e);
            alert("ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
        }
    }

    function setupFilters(cats) {
        const filterContainer = document.getElementById('category-filters');
        filterContainer.innerHTML = '<label style="display:block;margin-bottom:10px;"><input type="checkbox" id="all-select" checked> <strong>(ã™ã¹ã¦é¸æŠ)</strong></label>';
        cats.sort().forEach(cat => {
            if(!cat) return;
            const label = document.createElement('label');
            label.style.display = "block"; label.style.marginBottom = "5px";
            label.innerHTML = `<input type="checkbox" class="cat-check" checked value="${cat}"> ${cat}`;
            filterContainer.appendChild(label);
        });
        document.getElementById('all-select').addEventListener('change', function() {
            document.querySelectorAll('.cat-check').forEach(c => c.checked = this.checked);
            updateFilters();
        });
        document.querySelectorAll('.cat-check').forEach(c => c.addEventListener('change', updateFilters));
    }

    function updateFilters() {
        const searchText = document.getElementById('search-box').value.toLowerCase();
        const checkedCats = Array.from(document.querySelectorAll('.cat-check:checked')).map(i => i.value);
        markers.forEach(m => {
            const isCatMatch = checkedCats.includes(m.myCategory);
            const isSearchMatch = m.myName.toLowerCase().includes(searchText);
            if (isCatMatch && isSearchMatch) { map.addLayer(m); } else { map.removeLayer(m); }
        });
    }

    function showPage(pageId, elm) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active-nav'));
        elm.classList.add('active-nav');
        if(pageId === 'map-page') { setTimeout(() => { map.invalidateSize(); }, 100); }
    }

    function toggleMenu() { document.getElementById('menu').classList.toggle('show'); }
    document.getElementById('search-box').addEventListener('input', updateFilters);
    
    loadData();

    function goToMyLocation() {
        navigator.geolocation.getCurrentPosition(pos => {
            const latlng = [pos.coords.latitude, pos.coords.longitude];
            L.circleMarker(latlng, { radius: 10, color: '#1a73e8', fillColor: '#1a73e8', fillOpacity: 0.8 }).addTo(map).bindPopup("ç¾åœ¨åœ°");
            map.flyTo(latlng, 16);
        }, err => alert("ä½ç½®æƒ…å ±ã‚’ã‚ªãƒ³ã«ã—ã¦ãã ã•ã„"));
    }
</script>
</body>
</html>
