<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>è±Šæ©‹ãŠè²·ã„ç‰©ãƒãƒƒãƒ— - å®Œæˆç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-25..0" rel="stylesheet"/>
    <style>
        /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        body { font-family: sans-serif; margin: 0; padding: 0; background: #f8fafc; display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        .app-container { width: 100%; max-width: 430px; background: white; position: relative; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.1); }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼å›ºå®š */
        header { padding: 12px; background: rgba(255,255,255,0.9); backdrop-filter: blur(8px); border-bottom: 1px solid #e2e8f0; z-index: 5000; }
        .search-bar { display: flex; align-items: center; background: #f1f5f9; border-radius: 999px; padding: 6px 12px; border: 1px solid #e2e8f0; }
        .search-bar input { border: none; background: transparent; flex: 1; padding: 6px; outline: none; font-size: 14px; }
        .category-scroll { display: flex; gap: 8px; overflow-x: auto; padding: 10px 0 2px; scrollbar-width: none; }
        .category-scroll::-webkit-scrollbar { display: none; }
        .chip { padding: 6px 14px; border-radius: 999px; background: white; border: 1px solid #e2e8f0; font-size: 11px; font-weight: bold; white-space: nowrap; color: #64748b; cursor: pointer; }
        .chip.active { background: #0061A4; color: white; border-color: #0061A4; }

        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
        .content { flex: 1; position: relative; overflow: hidden; }
        .page { position: absolute; inset: 0; background: white; display: none; overflow-y: auto; }
        .page.active { display: block; }

        /* åœ°å›³ */
        #map { width: 100%; height: 100%; z-index: 1; }
        .my-location-btn { position: absolute; bottom: 20px; right: 16px; z-index: 1000; width: 48px; height: 48px; border-radius: 14px; background: white; border: 1px solid #e2e8f0; box-shadow: 0 4px 12px rgba(0,0,0,0.1); cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* ãƒ”ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .custom-pin { opacity: 0.85; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3)); }

        /* ãƒªã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ */
        .store-card { margin: 16px; border-radius: 20px; border: 1px solid #e2e8f0; background: white; overflow: hidden; }
        .card-info { padding: 12px; border-bottom: 1px solid #f1f5f9; }
        .card-price { padding: 12px; color: #dc2626; font-weight: bold; font-size: 14px; background: #fffbff; }
        .card-btns { padding: 12px; display: flex; gap: 8px; background: #f8fafc; }
        .btn { flex: 1; padding: 10px; border-radius: 12px; border: none; font-weight: bold; font-size: 11px; cursor: pointer; }
        .btn-map { background: #eff6ff; color: #0061A4; border: 1px solid #dbeafe; }
        .btn-post { background: #059669; color: white; }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“å›ºå®š */
        nav { display: flex; border-top: 1px solid #e2e8f0; padding-bottom: 25px; padding-top: 8px; background: white; z-index: 5000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; border: none; background: none; color: #94a3b8; cursor: pointer; }
        .nav-item.active { color: #0061A4; }
        .nav-icon { width: 56px; height: 30px; border-radius: 16px; display: flex; align-items: center; justify-content: center; }
        .nav-item.active .nav-icon { background: #dbeafe; }

        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        .post-form { padding: 20px; display: flex; flex-direction: column; gap: 16px; }
        .input-group label { display: block; font-size: 11px; font-weight: bold; color: #64748b; margin-bottom: 4px; margin-left: 4px; }
        .post-form input { width: 100%; padding: 14px; border-radius: 12px; border: none; background: #f1f5f9; box-sizing: border-box; }
        .submit-btn { background: #0061A4; color: white; padding: 16px; border-radius: 999px; border: none; font-weight: bold; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <div class="search-bar">
            <span class="material-symbols-outlined" style="color:#94a3b8">search</span>
            <input id="search-box" type="text" placeholder="åº—åã‚„å•†å“ã‚’æ¤œç´¢" oninput="updateFilters()">
        </div>
        <div id="category-chips" class="category-scroll"></div>
    </header>

    <div class="content">
        <div id="map-page" class="page active" style="overflow:hidden">
            <div id="map"></div>
            <button class="my-location-btn" onclick="goToMyLocation()">
                <span class="material-symbols-outlined" style="color:#0061A4">my_location</span>
            </button>
        </div>

        <div id="list-page" class="page">
            <div id="list-count" style="padding: 16px 16px 0; font-size: 12px; font-weight: bold; color: #64748b;"></div>
            <div id="store-list-content"></div>
        </div>

        <div id="post-page" class="page">
            <div class="post-form">
                <h2 style="margin: 0 0 10px;">ä¾¡æ ¼ã‚’æŠ•ç¨¿</h2>
                <div class="input-group">
                    <label>åº—èˆ—å</label>
                    <input id="post-store-name" placeholder="åº—åã‚’å…¥åŠ›">
                </div>
                <div class="input-group">
                    <label>å•†å“å</label>
                    <input id="post-item-name" placeholder="ä¾‹ï¼šãŸã¾ã”">
                </div>
                <div class="input-group">
                    <label>ä¾¡æ ¼ (ç¨æŠœ)</label>
                    <input id="post-price" type="number" placeholder="198">
                </div>
                <div class="input-group">
                    <label>å‚™è€ƒ</label>
                    <input id="post-note" placeholder="ä¾‹ï¼š10å€‹å…¥">
                </div>
                <button id="submit-btn" class="submit-btn" onclick="submitData()">æŠ•ç¨¿ã‚’é€ä¿¡ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <nav>
        <button id="btn-map" class="nav-item active" onclick="showPage('map-page', this)">
            <div class="nav-icon"><span class="material-symbols-outlined">map</span></div>
            <span style="font-size:10px; font-weight:bold;">ãƒãƒƒãƒ—</span>
        </button>
        <button id="btn-list" class="nav-item" onclick="showPage('list-page', this)">
            <div class="nav-icon"><span class="material-symbols-outlined">format_list_bulleted</span></div>
            <span style="font-size:10px; font-weight:bold;">ãƒªã‚¹ãƒˆ</span>
        </button>
        <button id="btn-post" class="nav-item" onclick="showPage('post-page', this)">
            <div class="nav-icon"><span class="material-symbols-outlined">add_circle</span></div>
            <span style="font-size:10px; font-weight:bold;">æŠ•ç¨¿</span>
        </button>
    </nav>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsb43W7oGI-uAyoWp19J1Z3WT3L48QW3TdJDIjseaTvLVtAMAfYX-sZNuLK6kuc2j2pbkLZ0I0p6Pp/pub?gid=0&single=true&output=csv';
    const gasUrl = 'https://script.google.com/macros/s/AKfycbz4OHWsfJStoowmEINpTMAXYEWu71AW5e5VDDyBCWTpAg5jznhgyouLjM5C3YEvUDo/exec';

    const categoryColors = { "ã‚¹ãƒ¼ãƒ‘ãƒ¼": "#34a853", "ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢": "#d93025", "JA": "#ffa502", "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ": "#0061A4" };
    let map, markers = [], allStoreData = [], currentCategory = "ã™ã¹ã¦";

    function formatPriceText(text) {
        if (!text) return "";
        return text.split('/').map(item => `<div style="margin-bottom:4px; padding-bottom:4px; border-bottom:1px solid #f8fafc">${item.trim()}</div>`).join('');
    }

    function initMap() {
        if (map) map.remove();
        map = L.map('map', { zoomControl: false, tap: false }).setView([34.7628, 137.3817], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        loadData();
    }

    async function loadData() {
        try {
            const res = await fetch(csvUrl + '&t=' + Date.now());
            const text = await res.text();
            const rows = text.split(/\r?\n/).slice(1);
            allStoreData = rows.map(row => {
                const cols = row.split(',');
                return { name: cols[0], lat: parseFloat(cols[1]), lng: parseFloat(cols[2]), category: cols[5] || "æœªåˆ†é¡", price: cols[6] || "" };
            }).filter(d => !isNaN(d.lat));
            renderUI();
        } catch (e) { console.error("Load Error"); }
    }

    function renderUI() {
        markers.forEach(m => map.removeLayer(m));
        markers = allStoreData.map(s => {
            const color = categoryColors[s.category] || categoryColors["ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ"];
            const icon = L.divIcon({
                className: 'custom-icon',
                html: `<div class="custom-pin"><span class="material-symbols-outlined" style="color:${color};font-size:34px;font-variation-settings:'FILL' 1">location_on</span></div>`,
                iconSize: [34, 34], iconAnchor: [17, 34]
            });
            const m = L.marker([s.lat, s.lng], { icon });
            m.bindPopup(`<b>${s.name}</b><div style="color:red;font-weight:bold;margin-top:5px;">${formatPriceText(s.price)}</div><button onclick="openPostWithStore('${s.name}')" style="width:100%;background:#059669;color:white;border:none;padding:5px;border-radius:4px;margin-top:8px;font-weight:bold;cursor:pointer">æŠ•ç¨¿ã™ã‚‹</button>`);
            m.storeData = s;
            return m;
        });

        const cats = ["ã™ã¹ã¦", ...new Set(allStoreData.map(d => d.category))];
        document.getElementById('category-chips').innerHTML = cats.map(c => `
            <div onclick="filterByCategory('${c}')" class="chip ${currentCategory === c ? 'active' : ''}">${c}</div>`).join('');
        updateFilters();
    }

    function filterByCategory(cat) { currentCategory = cat; renderUI(); }

    function updateFilters() {
        const query = document.getElementById('search-box').value.toLowerCase();
        const listContent = document.getElementById('store-list-content');
        listContent.innerHTML = "";
        let count = 0;

        markers.forEach(m => {
            const s = m.storeData;
            const matchesQuery = s.name.toLowerCase().includes(query) || s.price.toLowerCase().includes(query);
            const matchesCat = currentCategory === "ã™ã¹ã¦" || s.category === currentCategory;

            if (matchesQuery && matchesCat) {
                map.addLayer(m);
                count++;
                listContent.innerHTML += `
                    <div class="store-card">
                        <div class="card-info">
                            <span style="font-size:9px; color:#94a3b8; font-weight:bold;">${s.category}</span>
                            <div style="font-weight:bold; font-size:15px; margin-top:2px;">${s.name}</div>
                        </div>
                        <div class="card-price">${formatPriceText(s.price)}</div>
                        <div class="card-btns">
                            <button class="btn btn-map" onclick="map.flyTo([${s.lat},${s.lng}], 17); showPage('map-page', document.getElementById('btn-map'))">ğŸ—º åœ°å›³ã‚’è¡¨ç¤º</button>
                            <button class="btn btn-post" onclick="openPostWithStore('${s.name}')">ğŸ’° ä¾¡æ ¼ã‚’æŠ•ç¨¿</button>
                        </div>
                    </div>`;
            } else { map.removeLayer(m); }
        });
        document.getElementById('list-count').innerText = `${count}ä»¶è¡¨ç¤ºä¸­`;
    }

    function showPage(id, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => {
            n.classList.remove('active');
            n.querySelector('.material-symbols-outlined').style.fontVariationSettings = "'FILL' 0";
        });
        btn.classList.add('active');
        btn.querySelector('.material-symbols-outlined').style.fontVariationSettings = "'FILL' 1";
        if(id === 'map-page') setTimeout(() => map.invalidateSize(), 200);
    }

    function openPostWithStore(name) {
        document.getElementById('post-store-name').value = name;
        showPage('post-page', document.getElementById('btn-post'));
    }

    async function submitData() {
        const storeName = document.getElementById('post-store-name').value;
        const itemName = document.getElementById('post-item-name').value;
        const price = document.getElementById('post-price').value;
        const note = document.getElementById('post-note').value;
        if (!storeName || !itemName || !price) return alert("å…¥åŠ›ã—ã¦ãã ã•ã„");
        
        const b = document.getElementById('submit-btn');
        b.innerText = "é€ä¿¡ä¸­..."; b.disabled = true;
        try {
            await fetch(gasUrl, { method: "POST", mode: "no-cors", body: JSON.stringify({ storeName, itemName, price, note }) });
            alert("æŠ•ç¨¿å®Œäº†ï¼");
            loadData();
            showPage('map-page', document.getElementById('btn-map'));
        } catch (e) { alert("ã‚¨ãƒ©ãƒ¼"); }
        b.innerText = "æŠ•ç¨¿ã‚’é€ä¿¡ã™ã‚‹"; b.disabled = false;
    }

    function goToMyLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(p => map.flyTo([p.coords.latitude, p.coords.longitude], 16));
        }
    }

    window.onload = initMap;
</script>
</body>
</html>
