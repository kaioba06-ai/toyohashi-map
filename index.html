<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>è±Šæ©‹ãŠè²·ã„ç‰©ãƒãƒƒãƒ—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-25..0" rel="stylesheet"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* CSSã§å¼·åˆ¶çš„ã«ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’å›ºå®šã™ã‚‹è¨­å®š */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* å…¨ä½“ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¦æ­¢ */
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f8f9fa;
        }

        /* ç”»é¢å…¨ä½“ã®ã‚³ãƒ³ãƒ†ãƒŠ */
        .app-container {
            position: relative;
            width: 100%;
            max-width: 430px; /* ã‚¹ãƒãƒ›ã‚µã‚¤ã‚º */
            height: 100vh;
            margin: 0 auto;
            background: white;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* ãƒãƒƒãƒ—ã®ç®±ã‚’å¼·åˆ¶çš„ã«å…¨ç”»é¢ã«ã™ã‚‹ */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100% !important; /* ä½•ãŒä½•ã§ã‚‚é«˜ã•ã‚’å‡ºã™ */
            z-index: 1;
        }

        /* ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆã®åŸºæœ¬è¨­å®š */
        .page {
            position: absolute;
            inset: 0;
            background: white;
            z-index: 10;
            display: none; /* é€šå¸¸ã¯éè¡¨ç¤º */
            flex-direction: column;
            padding-top: 130px; /* ãƒ˜ãƒƒãƒ€ãƒ¼åˆ†ç©ºã‘ã‚‹ */
            padding-bottom: 90px; /* ãƒ•ãƒƒã‚¿ãƒ¼åˆ†ç©ºã‘ã‚‹ */
        }
        .page.active { display: flex; }

        /* ãƒãƒƒãƒ—ãƒšãƒ¼ã‚¸ã ã‘ã¯ä½™ç™½ãªã— */
        #map-page.active { display: block; padding: 0; }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒ•ãƒƒã‚¿ãƒ¼ã®å›ºå®š */
        header {
            position: fixed;
            top: 0;
            width: 100%;
            max-width: 430px;
            z-index: 1000;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            padding: 15px;
            box-sizing: border-box;
            border-bottom: 1px solid #eee;
        }
        nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 430px;
            z-index: 1000;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-around;
            padding: 10px 0 25px 0;
        }

        /* æ¤œç´¢ãƒãƒ¼ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .search-bar {
            background: white;
            border-radius: 99px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid #ddd;
        }
        .search-bar input {
            border: none;
            outline: none;
            width: 100%;
            margin-left: 10px;
            font-size: 16px;
        }

        /* ãƒªã‚¹ãƒˆã®ã‚«ãƒ¼ãƒ‰ */
        .store-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin: 15px;
            border: 1px solid #eee;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <div class="search-bar">
            <span class="material-symbols-outlined">search</span>
            <input id="search-box" oninput="updateFilters()" placeholder="ãŠåº—ã‚„å•†å“ã‚’æ¤œç´¢" type="text"/>
        </div>
        <div id="category-chips" style="display:flex; gap:10px; margin-top:10px; overflow-x:auto; padding-bottom:5px;">
            </div>
    </header>

    <div id="map-page" class="page active">
        <div id="map"></div>
        <button onclick="goToMyLocation()" style="position:absolute; bottom:110px; right:20px; z-index:500; width:56px; height:56px; border-radius:16px; background:white; border:none; shadow:0 4px 12px rgba(0,0,0,0.2); display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
            <span class="material-symbols-outlined" style="color:#0061A4;">my_location</span>
        </button>
    </div>

    <div id="list-page" class="page">
        <h2 style="padding:0 20px; font-weight:bold;">ğŸ“‹ åº—èˆ—ãƒ»åº•å€¤ä¸€è¦§</h2>
        <div id="store-list-content" style="overflow-y:auto; flex:1;"></div>
    </div>

    <div id="post-page" class="page">
        <div style="padding:20px;">
            <h2 style="font-weight:bold;">æ–°ä¾¡æ ¼ã‚’å ±å‘Š</h2>
            <div style="display:flex; flex-direction:column; gap:20px; margin-top:20px;">
                <input id="post-store-name" placeholder="åº—èˆ—å" style="padding:15px; border-radius:12px; border:1px solid #ddd;"/>
                <input id="post-item-name" placeholder="å•†å“å" style="padding:15px; border-radius:12px; border:1px solid #ddd;"/>
                <input id="post-price" type="number" placeholder="ä¾¡æ ¼" style="padding:15px; border-radius:12px; border:1px solid #ddd; font-size:20px; font-weight:bold;"/>
                <button onclick="submitData()" style="padding:15px; border-radius:99px; background:#0061A4; color:white; border:none; font-weight:bold;">æŠ•ç¨¿ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <nav>
        <button onclick="showPage('map-page')" style="background:none; border:none; display:flex; flex-direction:column; align-items:center;">
            <span class="material-symbols-outlined">map</span>
            <span style="font-size:10px;">ãƒãƒƒãƒ—</span>
        </button>
        <button onclick="showPage('list-page')" style="background:none; border:none; display:flex; flex-direction:column; align-items:center;">
            <span class="material-symbols-outlined">format_list_bulleted</span>
            <span style="font-size:10px;">ãƒªã‚¹ãƒˆ</span>
        </button>
        <button onclick="showPage('post-page')" style="background:none; border:none; display:flex; flex-direction:column; align-items:center;">
            <span class="material-symbols-outlined">add_circle</span>
            <span style="font-size:10px;">æŠ•ç¨¿</span>
        </button>
    </nav>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsb43W7oGI-uAyoWp19J1Z3WT3L48QW3TdJDIjseaTvLVtAMAfYX-sZNuLK6kuc2j2pbkLZ0I0p6Pp/pub?gid=0&single=true&output=csv';
    let map, markers = [], allStoreData = [];

    function initMap() {
        // ãƒãƒƒãƒ—ã‚’åˆæœŸåŒ–
        map = L.map('map', { zoomControl: false }).setView([34.7628, 137.3817], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        loadData();
    }

    async function loadData() {
        try {
            const res = await fetch(csvUrl + '&t=' + Date.now());
            const text = await res.text();
            const rows = text.split('\n').slice(1);
            allStoreData = rows.map(row => {
                const cols = row.split(',');
                return { 
                    name: cols[0]?.trim(), 
                    lat: parseFloat(cols[1]), 
                    lng: parseFloat(cols[2]), 
                    category: cols[5]?.trim() || "æœªåˆ†é¡", 
                    price: cols[6] || "ä¾¡æ ¼æœªç™»éŒ²" 
                };
            }).filter(d => !isNaN(d.lat));
            renderMarkers();
        } catch (e) { console.error("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e); }
    }

    function renderMarkers() {
        markers.forEach(m => map.removeLayer(m));
        markers = allStoreData.map(s => {
            const m = L.marker([s.lat, s.lng]).addTo(map);
            m.bindPopup(`<b>${s.name}</b><br>${s.price}`);
            m.storeData = s;
            return m;
        });
        updateFilters();
    }

    function updateFilters() {
        const query = document.getElementById('search-box').value.toLowerCase();
        const listContent = document.getElementById('store-list-content');
        listContent.innerHTML = "";

        markers.forEach(m => {
            const s = m.storeData;
            if (s.name.toLowerCase().includes(query) || s.price.toLowerCase().includes(query)) {
                map.addLayer(m);
                listContent.innerHTML += `
                    <div class="store-card">
                        <div style="font-size:12px; color:#666;">${s.category}</div>
                        <div style="font-size:18px; font-weight:bold;">${s.name}</div>
                        <div style="font-size:20px; color:#d93025; font-weight:900; margin-top:5px;">${s.price}</div>
                    </div>`;
            } else {
                map.removeLayer(m);
            }
        });
    }

    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        if (pageId === 'map-page') {
            setTimeout(() => { map.invalidateSize(); }, 200);
        }
    }

    function goToMyLocation() {
        navigator.geolocation.getCurrentPosition(p => {
            map.flyTo([p.coords.latitude, p.coords.longitude], 16);
        }, () => alert("ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"));
    }

    // èµ·å‹•æ™‚ã«ãƒãƒƒãƒ—ã‚’åˆæœŸåŒ–
    window.onload = initMap;
</script>
</body>
</html>
