<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>è±Šæ©‹ãŠè²·ã„ç‰©ãƒãƒƒãƒ— - å•†å“ãƒªã‚¹ãƒˆå¼·åŒ–ç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-25..0" rel="stylesheet"/>
    <style>
        /* ã‚¹ã‚¿ã‚¤ãƒ«ã¯å‰å›ã®ã‚‚ã®ã‚’ç¶™æ‰¿ */
        body { font-family: sans-serif; margin: 0; padding: 0; background: #f8fafc; display: flex; justify-content: center; height: 100dvh; overflow: hidden; }
        .app-container { width: 100%; max-width: 430px; background: white; position: relative; display: flex; flex-direction: column; height: 100%; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        header { padding: 12px; background: white; border-bottom: 1px solid #e2e8f0; z-index: 5000; flex-shrink: 0; position: relative; }
        .search-bar { display: flex; align-items: center; background: #f1f5f9; border-radius: 999px; padding: 6px 12px; border: 1px solid #e2e8f0; }
        .search-bar input { border: none; background: transparent; flex: 1; padding: 6px; outline: none; font-size: 14px; }
        #search-suggest { position: absolute; top: 100%; left: 12px; right: 12px; background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); max-height: 250px; overflow-y: auto; z-index: 6000; display: none; margin-top: 5px; border: 1px solid #e2e8f0; }
        .suggest-item { padding: 12px 16px; border-bottom: 1px solid #f1f5f9; cursor: pointer; }
        .suggest-name { font-weight: bold; font-size: 14px; color: #1e293b; display: block; }
        .category-scroll { display: flex; gap: 8px; overflow-x: auto; padding: 10px 0 2px; scrollbar-width: none; }
        .chip { padding: 6px 14px; border-radius: 999px; background: white; border: 1px solid #e2e8f0; font-size: 11px; font-weight: bold; white-space: nowrap; color: #64748b; }
        .chip.active { background: #0061A4; color: white; border-color: #0061A4; }
        .content { flex: 1; position: relative; overflow: hidden; }
        .page { position: absolute; inset: 0; background: white; display: none; overflow-y: auto; }
        .page.active { display: flex; flex-direction: column; }
        #map { width: 100%; height: 100%; z-index: 1; }
        .my-location-btn { position: absolute; bottom: 20px; right: 16px; z-index: 1000; width: 48px; height: 48px; border-radius: 14px; background: white; border: 1px solid #e2e8f0; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; }
        .custom-pin span { -webkit-text-stroke: 1.2px white; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.4)); font-variation-settings: 'FILL' 1; }
        .store-card { margin: 12px 16px; border-radius: 20px; border: 1px solid #e2e8f0; background: white; overflow: hidden; }
        .card-price { padding: 12px; color: #dc2626; font-weight: bold; font-size: 14px; background: #fffbff; border-bottom: 1px solid #f1f5f9; }
        .card-btns { padding: 10px; display: flex; gap: 8px; background: #f8fafc; }
        .btn { flex: 1; padding: 10px; border-radius: 12px; border: none; font-weight: bold; font-size: 11px; cursor: pointer; text-align: center; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 4px; }
        nav { display: flex; border-top: 1px solid #e2e8f0; padding: 8px 0 25px; background: white; z-index: 5000; flex-shrink: 0; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; border: none; background: none; color: #94a3b8; }
        .nav-item.active { color: #0061A4; }
        .nav-icon { width: 56px; height: 30px; border-radius: 16px; display: flex; align-items: center; justify-content: center; }
        .nav-item.active .nav-icon { background: #dbeafe; }
        .post-form { padding: 20px; display: flex; flex-direction: column; gap: 18px; }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        .input-group label { font-size: 11px; font-weight: bold; color: #64748b; margin-left: 5px; }
        .post-form input { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f1f5f9; box-sizing: border-box; font-size: 14px; }
    </style>
</head>
<body>

<div class="app-container" onclick="closeSuggest()">
    <header onclick="event.stopPropagation()">
        <div class="search-bar">
            <span class="material-symbols-outlined" style="color:#94a3b8">search</span>
            <input id="search-box" type="text" placeholder="åº—åã‚„å•†å“ã‚’æ¤œç´¢" oninput="handleSearch(this.value)">
        </div>
        <div id="search-suggest"></div>
        <div id="category-chips" class="category-scroll"></div>
    </header>

    <div class="content">
        <div id="map-page" class="page active">
            <div id="map"></div>
            <button class="my-location-btn" onclick="goToMyLocation()"><span class="material-symbols-outlined" style="color:#0061A4">my_location</span></button>
        </div>

        <div id="list-page" class="page">
            <div id="list-count" style="padding:15px; font-weight:bold; font-size:12px; color:#64748b"></div>
            <div id="store-list-content"></div>
        </div>

        <div id="post-page" class="page">
            <div class="post-form">
                <h2 style="margin:0; font-size: 20px;">ä¾¡æ ¼ã‚’æŠ•ç¨¿</h2>
                <div class="input-group">
                    <label>åº—èˆ—å</label>
                    <input id="post-store-name" list="store-list" placeholder="åº—åã‚’é¸æŠã¾ãŸã¯å…¥åŠ›">
                    <datalist id="store-list"></datalist>
                </div>
                <div class="input-group">
                    <label>å•†å“å</label>
                    <input id="post-item-name" list="item-list" placeholder="å•†å“ã‚’é¸æŠã¾ãŸã¯å…¥åŠ›">
                    <datalist id="item-list"></datalist>
                </div>
                <div class="input-group">
                    <label>ä¾¡æ ¼ (ç¨æŠœ)</label>
                    <input id="post-price" type="number" placeholder="198">
                </div>
                <div class="input-group">
                    <label>å‚™è€ƒ</label>
                    <input id="post-note" placeholder="ä¾‹ï¼š10å€‹å…¥ã€ãŠä¸€äººæ§˜1ç‚¹é™ã‚Š">
                </div>
                <button id="submit-btn" style="background:#0061A4; color:white; padding:16px; border-radius:999px; border:none; font-weight:bold; margin-top: 10px;" onclick="submitData()">æŠ•ç¨¿ã‚’é€ä¿¡ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <nav>
        <button id="btn-map" class="nav-item active" onclick="showPage('map-page', this)">
            <div class="nav-icon"><span class="material-symbols-outlined">map</span></div><span style="font-size:10px; font-weight:bold;">ãƒãƒƒãƒ—</span>
        </button>
        <button id="btn-list" class="nav-item" onclick="showPage('list-page', this)">
            <div class="nav-icon"><span class="material-symbols-outlined">format_list_bulleted</span></div><span style="font-size:10px; font-weight:bold;">ãƒªã‚¹ãƒˆ</span>
        </button>
        <button id="btn-post" class="nav-item" onclick="showPage('post-page', this)">
            <div class="nav-icon"><span class="material-symbols-outlined">add_circle</span></div><span style="font-size:10px; font-weight:bold;">æŠ•ç¨¿</span>
        </button>
    </nav>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsb43W7oGI-uAyoWp19J1Z3WT3L48QW3TdJDIjseaTvLVtAMAfYX-sZNuLK6kuc2j2pbkLZ0I0p6Pp/pub?gid=0&single=true&output=csv';
    const gasUrl = 'https://script.google.com/macros/s/AKfycbz4OHWsfJStoowmEINpTMAXYEWu71AW5e5VDDyBCWTpAg5jznhgyouLjM5C3YEvUDo/exec';

    const fixedItems = [
        "ãŸã¾ã”", "ç‰›ä¹³", "ç‰›ã“ã¾è‚‰ï¼ˆ100gå˜ä¾¡ï¼‰", "è±šã“ã¾è‚‰ï¼ˆ100gå˜ä¾¡ï¼‰", "é¶ã‚‚ã‚‚è‚‰ï¼ˆ100gå˜ä¾¡ï¼‰",
        "é¶ã‚€ã­è‚‰ï¼ˆ100gå˜ä¾¡ï¼‰", "ã•ã•ã¿ï¼ˆ100gå˜ä¾¡ï¼‰", "é¶çš®ï¼ˆ100gå˜ä¾¡ï¼‰", "ç ‚è‚ï¼ˆ100gå˜ä¾¡ï¼‰",
        "è±šã‚ã„ã³ããƒŸãƒ³ãƒï¼ˆ100gå˜ä¾¡ï¼‰", "é¶ã‚‚ã‚‚ãƒŸãƒ³ãƒï¼ˆ100gå˜ä¾¡ï¼‰", "é¶ã‚€ã­ãƒŸãƒ³ãƒï¼ˆ100gå˜ä¾¡ï¼‰",
        "è±†è…", "ã‚ã¶ã‚‰ã‚ã’", "ã†ã©ã‚“", "é•·ãƒã‚®", "ã‚­ãƒ£ãƒ™ãƒ„", "ã«ã‚“ã˜ã‚“", "ã˜ã‚ƒãŒã„ã‚‚", "ç‰ã­ã"
    ];

    const categoryColors = { "ã‚¹ãƒ¼ãƒ‘ãƒ¼": "#34a853", "ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢": "#d93025", "JA": "#ffa502", "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ": "#0061A4" };
    let map, markers = [], allStoreData = [], currentCategory = "ã™ã¹ã¦";

    function initMap() {
        map = L.map('map', { zoomControl: false, tap: false }).setView([34.7628, 137.3817], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        loadData();
    }

    async function loadData() {
        const res = await fetch(csvUrl + '&t=' + Date.now());
        const text = await res.text();
        const rows = text.split(/\r?\n/).slice(1);
        
        const pastItemCounts = {}; // éå»ã®å‡ºç¾é »åº¦ã‚’ã‚«ã‚¦ãƒ³ãƒˆ

        allStoreData = rows.map(row => {
            const c = row.split(',');
            const name = c[0];
            const priceInfo = c[6] || "";
            
            // éå»ã®å•†å“åã‚’è§£æã—ã¦ã‚«ã‚¦ãƒ³ãƒˆ
            if (priceInfo) {
                priceInfo.split('/').forEach(p => {
                    const itemName = p.split(':')[0]?.trim();
                    if (itemName) pastItemCounts[itemName] = (pastItemCounts[itemName] || 0) + 1;
                });
            }

            return { name, lat: parseFloat(c[1]), lng: parseFloat(c[2]), category: c[5] || "æœªåˆ†é¡", price: priceInfo };
        }).filter(d => !isNaN(d.lat));
        
        // åº—èˆ—ãƒªã‚¹ãƒˆ
        const storeDatalist = document.getElementById('store-list');
        const uniqueStoreNames = [...new Set(allStoreData.map(s => s.name))];
        storeDatalist.innerHTML = uniqueStoreNames.map(name => `<option value="${name}">`).join('');

        // å•†å“ãƒªã‚¹ãƒˆï¼ˆå›ºå®š20ä»¶ + éå»ã®é »å‡ºä¸Šä½10ä»¶ï¼‰
        const pastFrequentItems = Object.keys(pastItemCounts)
            .filter(name => !fixedItems.includes(name))
            .sort((a, b) => pastItemCounts[b] - pastItemCounts[a])
            .slice(0, 10);
        
        const fullItemList = [...fixedItems, ...pastFrequentItems];
        document.getElementById('item-list').innerHTML = fullItemList.map(item => `<option value="${item}">`).join('');

        renderUI();
    }

    function renderUI() {
        markers.forEach(m => map.removeLayer(m));
        markers = allStoreData.map(s => {
            const color = categoryColors[s.category] || categoryColors["ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ"];
            const icon = L.divIcon({
                className: 'custom-icon',
                html: `<div class="custom-pin"><span class="material-symbols-outlined" style="color:${color};font-size:34px;">location_on</span></div>`,
                iconSize: [34, 34], iconAnchor: [17, 34]
            });
            const m = L.marker([s.lat, s.lng], { icon });
            const googleMapUrl = `https://www.google.com/maps/dir/?api=1&destination=${s.lat},${s.lng}`;
            m.bindPopup(`<div style="min-width:150px"><b>${s.name}</b><div style="color:red;font-weight:bold;margin:5px 0;font-size:13px;">${s.price.replace(/\//g, '<br>')}</div><div style="display:flex;gap:5px;"><button onclick="openPostWithStore('${s.name}')" style="flex:1;background:#059669;color:white;border:none;padding:8px;border-radius:6px;font-size:10px;font-weight:bold;">æŠ•ç¨¿</button><a href="${googleMapUrl}" target="_blank" style="flex:1;background:#0061A4;color:white;padding:8px;border-radius:6px;font-size:10px;font-weight:bold;text-align:center;text-decoration:none;">ğŸš— æ¡ˆå†…</a></div></div>`);
            m.storeData = s;
            return m;
        });
        updateFilters();
    }

    // ï¼ˆä»¥ä¸‹ã€handleSearch, jumpToStore, showPage ç­‰ã®é–¢æ•°ã¯å‰å›ã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ãŸã‚çœç•¥ã—ã¦ã„ã¾ã™ãŒã€å®Œå…¨ãªå‹•ä½œã«ã¯å¿…è¦ã§ã™ï¼‰
    // å‰å›ã®å…¨ã‚³ãƒ¼ãƒ‰ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€ä¸Šè¨˜ loadData å†…ã®å•†å“ãƒªã‚¹ãƒˆå‡¦ç†ã‚’åæ˜ ã•ã›ã¦ãã ã•ã„ã€‚
    
    function handleSearch(val) {
        const suggest = document.getElementById('search-suggest');
        if (!val) { suggest.style.display = 'none'; updateFilters(); return; }
        const filtered = allStoreData.filter(s => s.name.includes(val) || s.price.includes(val)).slice(0, 10);
        if (filtered.length > 0) {
            suggest.innerHTML = filtered.map(s => `<div class="suggest-item" onclick="jumpToStore('${s.name}', ${s.lat}, ${s.lng})"><span class="suggest-name">${s.name}</span></div>`).join('');
            suggest.style.display = 'block';
        } else { suggest.style.display = 'none'; }
        updateFilters();
    }
    function jumpToStore(name, lat, lng) {
        document.getElementById('search-box').value = name;
        closeSuggest(); showPage('map-page', document.getElementById('btn-map'));
        map.flyTo([lat, lng], 17);
        setTimeout(() => { markers.find(m => m.storeData.name === name).openPopup(); }, 500);
    }
    function closeSuggest() { document.getElementById('search-suggest').style.display = 'none'; }
    function filterByCategory(cat) { currentCategory = cat; renderUI(); }
    function updateFilters() {
        const query = document.getElementById('search-box').value.toLowerCase();
        const listContent = document.getElementById('store-list-content');
        listContent.innerHTML = ""; let count = 0;
        markers.forEach(m => {
            const s = m.storeData;
            const match = (s.name.toLowerCase().includes(query) || s.price.toLowerCase().includes(query)) && (currentCategory === "ã™ã¹ã¦" || s.category === currentCategory);
            if (match) {
                map.addLayer(m); count++;
                listContent.innerHTML += `<div class="store-card"><div style="padding:12px;border-bottom:1px solid #f1f5f9"><span style="font-size:10px;color:#94a3b8;font-weight:bold;">${s.category}</span><div style="font-weight:bold;margin-top:2px;">${s.name}</div></div><div class="card-price">${s.price.replace(/\//g, '<br>')}</div><div class="card-btns"><button class="btn" style="background:#eff6ff;color:#0061A4;" onclick="jumpToStore('${s.name}', ${s.lat}, ${s.lng})">ğŸ—º åœ°å›³</button><a class="btn" style="background:#0061A4;color:white;" href="https://www.google.com/maps/dir/?api=1&destination=${s.lat},${s.lng}" target="_blank">ğŸš— æ¡ˆå†…</a></div></div>`;
            } else { map.removeLayer(m); }
        });
        document.getElementById('list-count').innerText = `${count}ä»¶è¡¨ç¤ºä¸­`;
    }
    function showPage(id, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => { n.classList.remove('active'); n.querySelector('.material-symbols-outlined').style.fontVariationSettings = "'FILL' 0"; });
        btn.classList.add('active'); btn.querySelector('.material-symbols-outlined').style.fontVariationSettings = "'FILL' 1";
        if(id === 'map-page') setTimeout(() => map.invalidateSize(), 200);
    }
    function openPostWithStore(name) { document.getElementById('post-store-name').value = name; showPage('post-page', document.getElementById('btn-post')); }
    async function submitData() {
        const storeName = document.getElementById('post-store-name').value;
        const itemName = document.getElementById('post-item-name').value;
        const price = document.getElementById('post-price').value;
        const note = document.getElementById('post-note').value;
        if (!storeName || !itemName || !price) return alert("å…¥åŠ›ã—ã¦ãã ã•ã„");
        const b = document.getElementById('submit-btn'); b.innerText = "é€ä¿¡ä¸­..."; b.disabled = true;
        try {
            await fetch(gasUrl, { method: "POST", mode: "no-cors", body: JSON.stringify({ storeName, itemName, price, note }) });
            alert("æŠ•ç¨¿å®Œäº†ï¼"); loadData(); showPage('map-page', document.getElementById('btn-map'));
        } catch (e) { alert("ã‚¨ãƒ©ãƒ¼"); }
        b.innerText = "æŠ•ç¨¿ã‚’é€ä¿¡ã™ã‚‹"; b.disabled = false;
    }
    function goToMyLocation() { if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(p => map.flyTo([p.coords.latitude, p.coords.longitude], 16)); } }
    window.onload = initMap;
</script>
</body>
</html>
