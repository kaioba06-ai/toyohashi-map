<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>è±Šæ©‹ãŠè²·ã„ç‰©ãƒãƒƒãƒ— - å®Œæˆç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-25..0" rel="stylesheet"/>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background: #f8fafc; display: flex; justify-content: center; height: 100dvh; overflow: hidden; }
        .app-container { width: 100%; max-width: 430px; background: white; position: relative; display: flex; flex-direction: column; height: 100%; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        
        header { padding: 10px 12px; background: white; border-bottom: 1px solid #e2e8f0; z-index: 5000; flex-shrink: 0; }
        .search-bar { display: flex; align-items: center; background: #f1f5f9; border-radius: 999px; padding: 4px 12px; border: 1px solid #e2e8f0; }
        .search-bar input { border: none; background: transparent; flex: 1; padding: 6px; outline: none; font-size: 14px; }
        
        .category-scroll { display: flex; gap: 6px; overflow-x: auto; padding: 8px 0 2px; scrollbar-width: none; }
        .category-scroll::-webkit-scrollbar { display: none; }
        .chip { padding: 5px 14px; border-radius: 999px; background: white; border: 1px solid #e2e8f0; font-size: 11px; font-weight: bold; white-space: nowrap; color: #64748b; cursor: pointer; }
        .chip.active { background: #0061A4; color: white; border-color: #0061A4; }

        .content { flex: 1; position: relative; overflow: hidden; }
        .page { position: absolute; inset: 0; background: white; display: none; overflow-y: auto; }
        .page.active { display: flex; flex-direction: column; }
        #map { width: 100%; height: 100%; z-index: 1; }
        
        .my-location-btn { position: absolute; bottom: 15px; right: 15px; z-index: 1000; width: 44px; height: 44px; border-radius: 12px; background: white; border: 1px solid #e2e8f0; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; }

        /* æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã®ä½™ç™½ã‚’æ¥µé™ã¾ã§ã‚«ãƒƒãƒˆ */
        .post-form { padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        .input-group { display: flex; flex-direction: column; gap: 0 !important; margin-bottom: 2px; }
        .input-group label { font-size: 12px; font-weight: 800; color: #475569; margin-left: 4px; margin-bottom: 2px; line-height: 1; }
        .post-form input { width: 100%; padding: 10px 14px; border-radius: 10px; border: 1px solid #cbd5e1; background: #f8fafc; box-sizing: border-box; font-size: 15px; transition: border-color 0.2s; }
        .post-form input:focus { border-color: #0061A4; outline: none; background: white; }

        #submit-btn { background: #0061A4; color: white; padding: 14px; border-radius: 999px; border: none; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; box-shadow: 0 4px 12px rgba(0, 97, 164, 0.2); }

        nav { display: flex; border-top: 1px solid #e2e8f0; padding: 4px 0 15px; background: white; z-index: 5000; flex-shrink: 0; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 2px; border: none; background: none; color: #94a3b8; cursor: pointer; padding: 4px 0; }
        .nav-item.active { color: #0061A4; }
        .nav-icon { width: 48px; height: 26px; border-radius: 14px; display: flex; align-items: center; justify-content: center; }
        .nav-item.active .nav-icon { background: #dbeafe; }
        .nav-text { font-size: 9px; font-weight: bold; }
        .nav-item .material-symbols-outlined { font-size: 22px; }

        .custom-pin span { -webkit-text-stroke: 1.2px white; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)); font-variation-settings: 'FILL' 1; display: block; }
        .store-card { margin: 10px 12px; border-radius: 16px; border: 1px solid #e2e8f0; background: white; overflow: hidden; }
        .card-price { padding: 10px; color: #dc2626; font-weight: bold; font-size: 13px; background: #fffbff; border-bottom: 1px solid #f1f5f9; }
        .card-btns { padding: 8px; display: flex; gap: 6px; background: #f8fafc; }
        .btn { flex: 1; padding: 8px; border-radius: 10px; border: none; font-weight: bold; font-size: 11px; cursor: pointer; text-align: center; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 4px; }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <div class="search-bar">
            <span class="material-symbols-outlined" style="color:#94a3b8; font-size: 20px;">search</span>
            <input id="search-box" type="text" list="search-list" placeholder="åº—åã‚„å•†å“ã‚’æ¤œç´¢" oninput="updateFilters()" onchange="handleListSelect(this.value)">
            <datalist id="search-list"></datalist>
        </div>
        <div id="category-chips" class="category-scroll"></div>
    </header>

    <div class="content">
        <div id="map-page" class="page active">
            <div id="map"></div>
            <button class="my-location-btn" onclick="goToMyLocation()"><span class="material-symbols-outlined" style="color:#0061A4">my_location</span></button>
        </div>

        <div id="list-page" class="page">
            <div id="list-count" style="padding:12px; font-weight:bold; font-size:11px; color:#64748b"></div>
            <div id="store-list-content"></div>
        </div>

        <div id="post-page" class="page">
            <div class="post-form">
                <h2 style="margin:0 0 5px 0; font-size: 18px;">ä¾¡æ ¼ã‚’æŠ•ç¨¿</h2>
                <div class="input-group"><label>åº—èˆ—å</label><input id="post-store-name" list="store-list" placeholder="åº—åã‚’é¸æŠã¾ãŸã¯å…¥åŠ›"><datalist id="store-list"></datalist></div>
                <div class="input-group"><label>å•†å“å</label><input id="post-item-name" list="item-list" placeholder="å•†å“ã‚’é¸æŠã¾ãŸã¯å…¥åŠ›"><datalist id="item-list"></datalist></div>
                <div class="input-group"><label>ä¾¡æ ¼ (ç¨æŠœ)</label><input id="post-price" type="number" inputmode="numeric" pattern="\d*" placeholder="198"></div>
                <div class="input-group"><label>å‚™è€ƒ</label><input id="post-note" placeholder="ä¾‹ï¼š10å€‹å…¥"></div>
                <button id="submit-btn" onclick="submitData()">æŠ•ç¨¿ã‚’é€ä¿¡ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <nav>
        <button id="btn-map" class="nav-item active" onclick="showPage('map-page', this)">
            <div class="nav-icon"><span class="material-symbols-outlined">map</span></div><span class="nav-text">ãƒãƒƒãƒ—</span>
        </button>
        <button id="btn-list" class="nav-item" onclick="showPage('list-page', this)">
            <div class="nav-icon"><span class="material-symbols-outlined">format_list_bulleted</span></div><span class="nav-text">ãƒªã‚¹ãƒˆ</span>
        </button>
        <button id="btn-post" class="nav-item" onclick="showPage('post-page', this)">
            <div class="nav-icon"><span class="material-symbols-outlined">add_circle</span></div><span class="nav-text">æŠ•ç¨¿</span>
        </button>
    </nav>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsb43W7oGI-uAyoWp19J1Z3WT3L48QW3TdJDIjseaTvLVtAMAfYX-sZNuLK6kuc2j2pbkLZ0I0p6Pp/pub?gid=0&single=true&output=csv';
    const gasUrl = 'https://script.google.com/macros/s/AKfycbz4OHWsfJStoowmEINpTMAXYEWu71AW5e5VDDyBCWTpAg5jznhgyouLjM5C3YEvUDo/exec';

    const fixedItems = ["ãŸã¾ã”", "ç‰›ä¹³", "ç‰›ã“ã¾è‚‰ï¼ˆ100gå˜ä¾¡ï¼‰", "è±šã“ã¾è‚‰ï¼ˆ100gå˜ä¾¡ï¼‰", "é¶ã‚‚ã‚‚è‚‰ï¼ˆ100gå˜ä¾¡ï¼‰", "é¶ã‚€ã­è‚‰ï¼ˆ100gå˜ä¾¡ï¼‰", "ã•ã•ã¿ï¼ˆ100gå˜ä¾¡ï¼‰", "é¶çš®ï¼ˆ100gå˜ä¾¡ï¼‰", "ç ‚è‚ï¼ˆ100gå˜ä¾¡ï¼‰", "è±šã‚ã„ã³ããƒŸãƒ³ãƒï¼ˆ100gå˜ä¾¡ï¼‰", "é¶ã‚‚ã‚‚ãƒŸãƒ³ãƒï¼ˆ100gå˜ä¾¡ï¼‰", "é¶ã‚€ã­ãƒŸãƒ³ãƒï¼ˆ100gå˜ä¾¡ï¼‰", "è±†è…", "ã‚ã¶ã‚‰ã‚ã’", "ã†ã©ã‚“", "é•·ãƒã‚®", "ã‚­ãƒ£ãƒ™ãƒ„", "ã«ã‚“ã˜ã‚“", "ã˜ã‚ƒãŒã„ã‚‚", "ç‰ã­ã"];
    const categoryColors = { "ã‚¹ãƒ¼ãƒ‘ãƒ¼": "#34a853", "ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢": "#d93025", "JA": "#ffa502", "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ": "#0061A4" };
    let map, markers = [], allStoreData = [], currentCategory = "ã™ã¹ã¦";

    function initMap() {
        map = L.map('map', { zoomControl: false, tap: false }).setView([34.7628, 137.3817], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        loadData();
    }

    async function loadData() {
        try {
            const res = await fetch(csvUrl + '&t=' + Date.now());
            const text = await res.text();
            const rows = text.split(/\r?\n/).slice(1);
            const pastItemCounts = {};
            allStoreData = rows.map(row => {
                const c = row.split(',');
                const priceInfo = c[6] || "";
                if (priceInfo) {
                    priceInfo.split('/').forEach(p => {
                        const itm = p.split(':')[0]?.trim();
                        if (itm) pastItemCounts[itm] = (pastItemCounts[itm] || 0) + 1;
                    });
                }
                return { name: c[0], lat: parseFloat(c[1]), lng: parseFloat(c[2]), category: c[5] || "æœªåˆ†é¡", price: priceInfo };
            }).filter(d => !isNaN(d.lat));
            const uniqueStoreNames = [...new Set(allStoreData.map(s => s.name))];
            document.getElementById('search-list').innerHTML = uniqueStoreNames.map(name => `<option value="${name}">`).join('');
            document.getElementById('store-list').innerHTML = uniqueStoreNames.map(name => `<option value="${name}">`).join('');
            const pastFrequent = Object.keys(pastItemCounts).filter(n => !fixedItems.includes(n)).sort((a,b) => pastItemCounts[b] - pastItemCounts[a]).slice(0, 10);
            document.getElementById('item-list').innerHTML = [...fixedItems, ...pastFrequent].map(i => `<option value="${i}">`).join('');
            renderUI();
        } catch (e) { console.error(e); }
    }

    function renderUI() {
        markers.forEach(m => map.removeLayer(m));
        const categories = ["ã™ã¹ã¦", ...new Set(allStoreData.map(d => d.category))];
        document.getElementById('category-chips').innerHTML = categories.map(cat => `<div onclick="filterByCategory('${cat}')" class="chip ${currentCategory === cat ? 'active' : ''}">${cat}</div>`).join('');
        markers = allStoreData.map(s => {
            const color = categoryColors[s.category] || categoryColors["ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ"];
            const icon = L.divIcon({ className: 'custom-icon', html: `<div class="custom-pin"><span class="material-symbols-outlined" style="color:${color};font-size:32px;">location_on</span></div>`, iconSize: [32, 32], iconAnchor: [16, 32] });
            const m = L.marker([s.lat, s.lng], { icon });
            m.bindPopup(`<div style="min-width:140px"><b>${s.name}</b><div style="color:red;font-weight:bold;margin:4px 0;font-size:12px;">${s.price.replace(/\//g, '<br>')}</div><div style="display:flex;gap:4px;"><button onclick="openPostWithStore('${s.name}')" style="flex:1;background:#059669;color:white;border:none;padding:6px;border-radius:6px;font-size:10px;font-weight:bold;cursor:pointer;">æŠ•ç¨¿</button><a href="https://www.google.com/maps/dir/?api=1&destination=${s.lat},${s.lng}" target="_blank" style="flex:1;background:#0061A4;color:white;padding:6px;border-radius:6px;font-size:10px;font-weight:bold;text-align:center;text-decoration:none;">ğŸš— æ¡ˆå†…</a></div></div>`);
            m.storeData = s;
            return m;
        });
        updateFilters();
    }

    function filterByCategory(cat) { currentCategory = cat; renderUI(); }

    function updateFilters() {
        const query = document.getElementById('search-box').value.toLowerCase();
        const listContent = document.getElementById('store-list-content');
        listContent.innerHTML = ""; let count = 0;
        markers.forEach(m => {
            const s = m.storeData;
            const match = (s.name.toLowerCase().includes(query) || s.price.toLowerCase().includes(query)) && (currentCategory === "ã™ã¹ã¦" || s.category === currentCategory);
            if (match) {
                map.addLayer(m); count++;
                listContent.innerHTML += `<div class="store-card"><div style="padding:10px;border-bottom:1px solid #f1f5f9"><span style="font-size:9px;color:#94a3b8;font-weight:bold;">${s.category}</span><div style="font-weight:bold;font-size:14px;">${s.name}</div></div><div class="card-price">${s.price.replace(/\//g, '<br>')}</div><div class="card-btns"><button class="btn" style="background:#eff6ff;color:#0061A4;" onclick="jumpToStore('${s.name}', ${s.lat}, ${s.lng})">ğŸ—º åœ°å›³</button><a class="btn" style="background:#0061A4;color:white;" href="https://www.google.com/maps/dir/?api=1&destination=${s.lat},${s.lng}" target="_blank">ğŸš— æ¡ˆå†…</a></div></div>`;
            } else { map.removeLayer(m); }
        });
        document.getElementById('list-count').innerText = `${count}ä»¶è¡¨ç¤ºä¸­`;
    }

    function handleListSelect(val) {
        const target = allStoreData.find(s => s.name === val);
        if (target) jumpToStore(target.name, target.lat, target.lng);
    }

    function jumpToStore(name, lat, lng) {
        showPage('map-page', document.getElementById('btn-map'));
        map.flyTo([lat, lng], 17);
        setTimeout(() => { const m = markers.find(m => m.storeData.name === name); if (m) m.openPopup(); }, 500);
    }

    function showPage(id, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => { n.classList.remove('active'); n.querySelector('.material-symbols-outlined').style.fontVariationSettings = "'FILL' 0"; });
        btn.classList.add('active'); btn.querySelector('.material-symbols-outlined').style.fontVariationSettings = "'FILL' 1";
        if(id === 'map-page') setTimeout(() => map.invalidateSize(), 200);
    }

    function openPostWithStore(name) { document.getElementById('post-store-name').value = name; showPage('post-page', document.getElementById('btn-post')); }

    async function submitData() {
        const storeName = document.getElementById('post-store-name').value.trim();
        const itemName = document.getElementById('post-item-name').value.trim();
        const price = document.getElementById('post-price').value;
        const note = document.getElementById('post-note').value;
        if (!storeName || !itemName || !price) return alert("å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        if (!allStoreData.map(s => s.name).includes(storeName)) return alert("âš ï¸ åº—èˆ—æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„ã€‚");

        const b = document.getElementById('submit-btn');
        const originalText = b.innerText;
        b.innerText = "é€ä¿¡ä¸­..."; b.disabled = true;

        try {
            await fetch(gasUrl, { method: "POST", mode: "no-cors", body: JSON.stringify({ storeName, itemName, price, note }) });
            document.getElementById('post-item-name').value = "";
            document.getElementById('post-price').value = "";
            document.getElementById('post-note').value = "";
            document.getElementById('post-item-name').focus();
            b.innerText = "é€ä¿¡å®Œäº†ï¼æ¬¡ã‚’ã©ã†ã"; b.style.background = "#059669";
            setTimeout(() => { b.innerText = originalText; b.style.background = "#0061A4"; b.disabled = false; }, 2000);
            loadData();
        } catch (e) { alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"); b.disabled = false; }
    }

    function goToMyLocation() { if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(p => map.flyTo([p.coords.latitude, p.coords.longitude], 16)); } }
    window.onload = initMap;
</script>
</body>
</html>
