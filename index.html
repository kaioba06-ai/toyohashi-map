<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>è±Šæ©‹ãŠè²·ã„ç‰©ãƒãƒƒãƒ—</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; background: #f0f2f5; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        header { background: #fff; padding: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 6000; }
        .search-container { display: flex; gap: 8px; }
        #search-box { flex: 1; padding: 10px 15px; border-radius: 20px; border: 1px solid #ddd; font-size: 16px; outline: none; }
        #menu-toggle { background: #1a73e8; color: #fff; border: none; border-radius: 20px; padding: 0 15px; font-weight: bold; }
        
        .page { display: none; flex: 1; width: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; position: relative; }
        .active { display: flex; flex-direction: column; }
        
        #map { flex: 1; width: 100%; z-index: 1; }
        
        /* ğŸ“ç¾åœ¨åœ°ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ä¿®æ­£ */
        .location-btn { 
            position: absolute; 
            bottom: 25px; 
            right: 20px; 
            z-index: 10000; /* æœ€å‰é¢ã« */
            background: white; 
            border-radius: 50%; 
            width: 55px; 
            height: 55px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
            font-size: 28px; 
            color: #1a73e8; 
            cursor: pointer;
            border: none;
        }

        #menu { position: fixed; top: 65px; right: 10px; z-index: 7000; background: white; width: 240px; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: none; }
        #menu.show { display: block; }
        .list-container { padding: 15px; }
        .store-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .category-tag { display: inline-block; padding: 3px 8px; border-radius: 10px; font-size: 10px; color: white; margin-bottom: 5px; font-weight: bold; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 14px; color: #666; font-weight: bold; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; font-size: 16px; }
        
        .post-btn { background: #1a73e8; color: white; border: none; padding: 15px; border-radius: 8px; width: 100%; font-weight: bold; font-size: 16px; }
        
        #footer-nav { height: 65px; background: #fff; display: flex; border-top: 1px solid #eee; z-index: 5000; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; color: #5f6368; background: none; border: none; }
        .nav-item.active-nav { color: #1a73e8; font-weight: bold; }
        .nav-icon { font-size: 20px; margin-bottom: 2px; }
        
        .popup-post-btn { background: #34a853; color: white !important; padding: 8px; border-radius: 5px; width: 100%; border: none; margin-top: 8px; font-weight: bold; display: block; text-align: center; text-decoration: none; }
    </style>
</head>
<body>

<header>
    <div class="search-container">
        <input type="text" id="search-box" list="search-candidates" placeholder="åº—åã‚„å•†å“ã§æ¤œç´¢..." oninput="updateFilters()">
        <datalist id="search-candidates"></datalist>
        <button id="menu-toggle" onclick="toggleMenu()">ğŸ” çµè¾¼</button>
    </div>
</header>

<div id="menu">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <strong>ã‚«ãƒ†ã‚´ãƒªã§çµã‚Šè¾¼ã¿</strong>
        <label style="font-size: 12px; color: #1a73e8; cursor: pointer;">
            <input type="checkbox" id="all-check" checked onchange="toggleAllCategories(this.checked)"> å…¨é¸æŠ
        </label>
    </div>
    <hr>
    <div id="category-filters"></div>
</div>

<div id="map-page" class="page active">
    <div id="map"></div>
    <button class="location-btn" onclick="goToMyLocation()" aria-label="ç¾åœ¨åœ°ã¸ç§»å‹•">ğŸ“</button>
</div>

<div id="list-page" class="page">
    <div class="list-container">
        <h3>ğŸ“‹ åº—èˆ—ãƒ»åº•å€¤ä¸€è¦§</h3>
        <div id="store-list-content"></div>
    </div>
</div>

<div id="post-page" class="page">
    <div style="padding: 20px;">
        <h2 style="text-align:center;">ğŸ’° æƒ…å ±æŠ•ç¨¿</h2>
        <div style="background:white; padding:20px; border-radius:15px;">
            <div class="form-group">
                <label>åº—å</label>
                <input type="text" id="post-store-name" list="store-list-candidates" placeholder="åº—åã‚’é¸æŠã¾ãŸã¯å…¥åŠ›">
                <datalist id="store-list-candidates"></datalist>
            </div>
            <div class="form-group">
                <label>å•†å“å</label>
                <input type="text" id="post-item-name" list="item-list-candidates" placeholder="å•†å“åã‚’é¸æŠã¾ãŸã¯å…¥åŠ›">
                <datalist id="item-list-candidates"></datalist>
            </div>
            <div class="form-group">
                <label>ä¾¡æ ¼ (ç¨æŠœãƒ»æ•°å€¤ã®ã¿)</label>
                <input type="number" id="post-price" inputmode="numeric" placeholder="ä¾‹ï¼š198">
            </div>           
            <div class="form-group">
                <label>å‚™è€ƒ</label>
                <textarea id="post-memo" placeholder="é‡ã‚„ã‚µã‚¤ã‚ºãªã©"></textarea>
            </div>
            <button onclick="submitData()" id="submit-btn" class="post-btn">æŠ•ç¨¿ã™ã‚‹</button>
        </div>
    </div>
</div>

<nav id="footer-nav">
    <button class="nav-item active-nav" onclick="showPage('map-page', this)"><span class="nav-icon">ğŸ—ºï¸</span>åœ°å›³</button>
    <button class="nav-item" onclick="showPage('list-page', this)"><span class="nav-icon">ğŸ“‹</span>ä¸€è¦§</button>
    <button class="nav-item" onclick="showPage('post-page', this)"><span class="nav-icon">â•</span>æŠ•ç¨¿</button>
</nav>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsb43W7oGI-uAyoWp19J1Z3WT3L48QW3TdJDIjseaTvLVtAMAfYX-sZNuLK6kuc2j2pbkLZ0I0p6Pp/pub?gid=0&single=true&output=csv';
    const gasUrl = 'https://script.google.com/macros/s/AKfycbz4OHWsfJStoowmEINpTMAXYEWu71AW5e5VDDyBCWTpAg5jznhgyouLjM5C3YEvUDo/exec';

    const categoryColors = { "ã‚¹ãƒ¼ãƒ‘ãƒ¼": "#ff4757", "æ¥­å‹™ã‚¹ãƒ¼ãƒ‘ãƒ¼": "#2f3542", "ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢": "#2ed573", "JA": "#ffa502", "ç›´è²©æ‰€": "#7bed9f", "å…«ç™¾å±‹": "#ff6348", "æœç‰©å±‹": "#eccc68", "é­šå±‹": "#1e90ff" };
    const fixedItems = ["ãŸã¾ã”", "ç‰›ä¹³", "ç‰›ã“ã¾è‚‰ï¼ˆ100gå˜ä¾¡ï¼‰", "è±šã“ã¾è‚‰ï¼ˆ100gå˜ä¾¡ï¼‰", "é¶ã‚‚ã‚‚è‚‰ï¼ˆ100gå˜ä¾¡ï¼‰", "é¶ã‚€ã­è‚‰ï¼ˆ100gå˜ä¾¡ï¼‰", "ã•ã•ã¿ï¼ˆ100gå˜ä¾¡ï¼‰", "é¶çš®ï¼ˆ100gå˜ä¾¡ï¼‰", "ç ‚è‚ï¼ˆ100gå˜ä¾¡ï¼‰", "è±šã‚ã„ã³ããƒŸãƒ³ãƒï¼ˆ100gå˜ä¾¡ï¼‰", "é¶ã‚‚ã‚‚ãƒŸãƒ³ãƒï¼ˆ100gå˜ä¾¡ï¼‰", "é¶ã‚€ã­ãƒŸãƒ³ãƒï¼ˆ100gå˜ä¾¡ï¼‰", "è±†è…", "ã‚ã¶ã‚‰ã‚ã’", "ã†ã©ã‚“", "é•·ãƒã‚®", "ã‚­ãƒ£ãƒ™ãƒ„", "ã«ã‚“ã˜ã‚“", "ã˜ã‚ƒãŒã„ã‚‚", "ç‰ã­ã"];

    let markers = [];
    let allStoreData = [];
    let watchId = null; // ç¾åœ¨åœ°è¿½è·¡ç”¨
    
    const map = L.map('map', { zoomControl: false }).setView([34.7628, 137.3817], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    function csvToArray(str) {
        return str.split(/\r?\n/).map(row => {
            let cols = [], current = "", inQuotes = false;
            for (let c of row) {
                if (c === '"') inQuotes = !inQuotes;
                else if (c === ',' && !inQuotes) { cols.push(current); current = ""; }
                else current += c;
            }
            cols.push(current); return cols;
        });
    }

    async function loadData() {
        try {
            const res = await fetch(csvUrl + '&t=' + Date.now());
            const data = csvToArray(await res.text()).slice(1);
            allStoreData = data.map(cols => ({
                name: (cols[0] || "").trim(),
                lat: parseFloat(cols[1]), 
                lng: parseFloat(cols[2]),
                category: (cols[5] || "æœªåˆ†é¡").trim(), 
                price: cols[6] || ""
            })).filter(d => !isNaN(d.lat));
            
            createMarkers();
            setupCategoryMenu();
            updateFilters();
            updateStoreDatalist();
            updateItemDatalist();
        } catch (e) { console.error("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e); }
    }

    function createMarkers() {
        markers.forEach(m => map.removeLayer(m));
        markers = allStoreData.map(store => {
            const m = L.circleMarker([store.lat, store.lng], { 
                radius: 10, fillColor: categoryColors[store.category] || "#777", color: "#fff", weight: 2, fillOpacity: 0.8 
            });

            const priceHtml = store.price ? `<div style="font-size:12px;color:red;font-weight:bold;margin-top:5px;">${store.price.split('/').join('<br>')}</div>` : "";
            const googleMapUrl = `https://www.google.com/maps/search/?api=1&query=${store.lat},${store.lng}`;

            m.bindPopup(`
                <strong>${store.name}</strong><br>
                <small>${store.category}</small>
                ${priceHtml}
                <div style="display: flex; gap: 5px; margin-top: 8px;">
                    <a href="${googleMapUrl}" target="_blank" rel="noopener noreferrer" style="background: #1a73e8; color: white !important; padding: 8px; border-radius: 5px; flex: 1; text-align: center; text-decoration: none; font-size: 11px; font-weight: bold;">ğŸ—ºï¸ æ¡ˆå†…</a>
                    <button class="popup-post-btn" onclick="openPostWithStore('${store.name}')" style="flex: 1; margin-top: 0; font-size: 11px;">ğŸ’° å ±å‘Š</button>
                </div>
            `);
            m.storeData = store;
            return m.addTo(map);
        });
    }

    function updateFilters() {
        const search = document.getElementById('search-box').value.toLowerCase();
        const list = document.getElementById('store-list-content');
        list.innerHTML = "";
        
        const checkedCategories = Array.from(document.querySelectorAll('#category-filters input:checked')).map(cb => cb.value);
        
        markers.forEach(m => {
            const s = m.storeData;
            const isCategoryVisible = checkedCategories.includes(s.category);
            const isSearchMatch = s.name.toLowerCase().includes(search) || s.price.toLowerCase().includes(search);

            if (isCategoryVisible && isSearchMatch) {
                map.addLayer(m);
                const googleMapUrl = `https://www.google.com/maps/search/?api=1&query=${s.lat},${s.lng}`;
                const card = document.createElement('div');
                card.className = 'store-card';
                card.innerHTML = `
                    <div class="category-tag" style="background:${categoryColors[s.category] || '#777'}">${s.category}</div>
                    <div style="font-weight:bold;">${s.name}</div>
                    <div style="color:red; font-size:14px; margin-top:5px;">${s.price}</div>
                    <div style="display: flex; gap: 8px; margin-top: 10px;">
                        <a href="${googleMapUrl}" target="_blank" rel="noopener noreferrer" style="flex: 1; border: 1px solid #1a73e8; color: #1a73e8; text-align: center; text-decoration: none; padding: 8px; border-radius: 5px; font-size: 13px; font-weight: bold;">ğŸ—ºï¸ æ¡ˆå†…</a>
                        <button onclick="openPostWithStore('${s.name}')" style="flex: 1; border: 1px solid #34a853; color: #34a853; background: none; padding: 8px; border-radius: 5px; font-size: 13px; font-weight: bold;">ğŸ’° å ±å‘Š</button>
                    </div>
                `;
                list.appendChild(card);
            } else {
                map.removeLayer(m);
            }
        });
    }

    // ç¾åœ¨åœ°ã®å¸¸æ™‚è¡¨ç¤ºã¨è¿½è·¡
    function startTracking() {
        if (!navigator.geolocation) return;
        watchId = navigator.geolocation.watchPosition((p) => {
            const ll = [p.coords.latitude, p.coords.longitude];
            if (window.myLocMarker) {
                window.myLocMarker.setLatLng(ll);
            } else {
                window.myLocMarker = L.circleMarker(ll, { radius: 8, color: '#fff', fillColor: '#1a73e8', fillOpacity: 1, weight: 2 }).addTo(map);
            }
        }, null, { enableHighAccuracy: true });
    }

    function goToMyLocation() {
        if (!navigator.geolocation) { alert("ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚"); return; }
        navigator.geolocation.getCurrentPosition((p) => {
            const ll = [p.coords.latitude, p.coords.longitude];
            map.flyTo(ll, 16, { animate: true, duration: 1.5 });
        });
    }

    // --- ãã®ä»–åŸºæœ¬é–¢æ•° ---
    function setupCategoryMenu() {
        const cats = [...new Set(allStoreData.map(d => d.category))].sort();
        document.getElementById('category-filters').innerHTML = cats.map(c => `<label style="display:block;margin:5px 0;"><input type="checkbox" checked value="${c}" onchange="updateFilters()"> ${c}</label>`).join('');
    }
    function toggleMenu() { document.getElementById('menu').classList.toggle('show'); }
    function toggleAllCategories(isChecked) {
        document.querySelectorAll('#category-filters input[type="checkbox"]').forEach(cb => cb.checked = isChecked);
        updateFilters();
    }
    function showPage(id, elm) { 
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); 
        document.getElementById(id).classList.add('active'); 
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active-nav')); 
        elm.classList.add('active-nav'); 
        if(id==='map-page') setTimeout(() => map.invalidateSize(), 100); 
    }
    function openPostWithStore(name) { document.getElementById('post-store-name').value = name; showPage('post-page', document.querySelectorAll('.nav-item')[2]); }
    function updateStoreDatalist() {
        const names = [...new Set(allStoreData.map(s => s.name))].sort();
        document.getElementById('store-list-candidates').innerHTML = names.map(n => `<option value="${n}">`).join('');
    }
    function updateItemDatalist() {
        let history = JSON.parse(localStorage.getItem('post_history') || "[]");
        document.getElementById('item-list-candidates').innerHTML = [...new Set([...history, ...fixedItems])].map(i => `<option value="${i}">`).join('');
    }

    async function submitData() {
        const storeName = document.getElementById('post-store-name').value;
        const itemName = document.getElementById('post-item-name').value;
        const price = document.getElementById('post-price').value;
        const memo = document.getElementById('post-memo').value;
        if (!storeName || !itemName || !price) { alert("å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
        const btn = document.getElementById('submit-btn');
        btn.innerText = "é€ä¿¡ä¸­..."; btn.disabled = true;
        try {
            await fetch(gasUrl, { method: "POST", mode: "no-cors", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ storeName, itemName, price, memo }) });
            let history = JSON.parse(localStorage.getItem('post_history') || "[]");
            history.unshift(itemName);
            localStorage.setItem('post_history', JSON.stringify([...new Set(history)].slice(0, 10)));
            alert("æŠ•ç¨¿å®Œäº†ï¼");
            document.getElementById('post-item-name').value = ""; document.getElementById('post-price').value = ""; document.getElementById('post-memo').value = "";
            showPage('map-page', document.querySelectorAll('.nav-item')[0]);
        } catch (e) { alert("ã‚¨ãƒ©ãƒ¼"); }
        finally { btn.innerText = "æŠ•ç¨¿ã™ã‚‹"; btn.disabled = false; }
    }

    loadData();
    startTracking();
</script>
</body>
</html>
