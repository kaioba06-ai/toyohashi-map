<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>Ë±äÊ©ã„ÅäË≤∑„ÅÑÁâ©„Éû„ÉÉ„Éó - ÂÆåÊàêÁâà</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-25..0" rel="stylesheet"/>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background: #f8fafc; display: flex; justify-content: center; height: 100dvh; overflow: hidden; }
        .app-container { width: 100%; max-width: 430px; background: white; position: relative; display: flex; flex-direction: column; height: 100%; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        header { padding: 12px; background: white; border-bottom: 1px solid #e2e8f0; z-index: 5000; flex-shrink: 0; position: relative; }
        .search-bar { display: flex; align-items: center; background: #f1f5f9; border-radius: 999px; padding: 6px 12px; border: 1px solid #e2e8f0; }
        .search-bar input { border: none; background: transparent; flex: 1; padding: 6px; outline: none; font-size: 14px; }
        #search-suggest { position: absolute; top: 100%; left: 12px; right: 12px; background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); max-height: 250px; overflow-y: auto; z-index: 6000; display: none; margin-top: 5px; border: 1px solid #e2e8f0; }
        .suggest-item { padding: 12px 16px; border-bottom: 1px solid #f1f5f9; cursor: pointer; }
        .suggest-name { font-weight: bold; font-size: 14px; color: #1e293b; display: block; }

        .category-scroll { display: flex; gap: 8px; overflow-x: auto; padding: 10px 0 4px; scrollbar-width: none; }
        .category-scroll::-webkit-scrollbar { display: none; }
        .chip { padding: 6px 16px; border-radius: 999px; background: white; border: 1px solid #e2e8f0; font-size: 11px; font-weight: bold; white-space: nowrap; color: #64748b; cursor: pointer; transition: all 0.2s; }
        .chip.active { background: #0061A4; color: white; border-color: #0061A4; box-shadow: 0 2px 8px rgba(0, 97, 164, 0.3); }

        .content { flex: 1; position: relative; overflow: hidden; }
        .page { position: absolute; inset: 0; background: white; display: none; overflow-y: auto; }
        .page.active { display: flex; flex-direction: column; }
        #map { width: 100%; height: 100%; z-index: 1; }
        .my-location-btn { position: absolute; bottom: 20px; right: 16px; z-index: 1000; width: 48px; height: 48px; border-radius: 14px; background: white; border: 1px solid #e2e8f0; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; }
        .custom-pin span { -webkit-text-stroke: 1.2px white; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.4)); font-variation-settings: 'FILL' 1; }
        .store-card { margin: 12px 16px; border-radius: 20px; border: 1px solid #e2e8f0; background: white; overflow: hidden; }
        .card-price { padding: 12px; color: #dc2626; font-weight: bold; font-size: 14px; background: #fffbff; border-bottom: 1px solid #f1f5f9; }
        .card-btns { padding: 10px; display: flex; gap: 8px; background: #f8fafc; }
        .btn { flex: 1; padding: 10px; border-radius: 12px; border: none; font-weight: bold; font-size: 11px; cursor: pointer; text-align: center; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 4px; }
        
        nav { display: flex; border-top: 1px solid #e2e8f0; padding: 8px 0 25px; background: white; z-index: 5000; flex-shrink: 0; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; border: none; background: none; color: #94a3b8; cursor: pointer; }
        .nav-item.active { color: #0061A4; }
        .nav-icon { width: 56px; height: 30px; border-radius: 16px; display: flex; align-items: center; justify-content: center; }
        .nav-item.active .nav-icon { background: #dbeafe; }

        .post-form { padding: 20px; display: flex; flex-direction: column; gap: 18px; }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        .input-group label { font-size: 11px; font-weight: bold; color: #64748b; margin-left: 5px; }
        .post-form input { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f1f5f9; box-sizing: border-box; font-size: 14px; }
    </style>
</head>
<body>

<div class="app-container" onclick="closeSuggest()">
    <header onclick="event.stopPropagation()">
        <div class="search-bar">
            <span class="material-symbols-outlined" style="color:#94a3b8">search</span>
            <input id="search-box" type="text" placeholder="Â∫óÂêç„ÇÑÂïÜÂìÅ„ÇíÊ§úÁ¥¢" oninput="handleSearch(this.value)">
        </div>
        <div id="search-suggest"></div>
        <div id="category-chips" class="category-scroll"></div>
    </header>

    <div class="content">
        <div id="map-page" class="page active">
            <div id="map"></div>
            <button class="my-location-btn" onclick="goToMyLocation()"><span class="material-symbols-outlined" style="color:#0061A4">my_location</span></button>
        </div>

        <div id="list-page" class="page">
            <div id="list-count" style="padding:15px; font-weight:bold; font-size:12px; color:#64748b"></div>
            <div id="store-list-content"></div>
        </div>

        <div id="post-page" class="page">
            <div class="post-form">
                <h2 style="margin:0; font-size: 20px;">‰æ°Ê†º„ÇíÊäïÁ®ø</h2>
                <div class="input-group">
                    <label>Â∫óËàóÂêç</label>
                    <input id="post-store-name" list="store-list" placeholder="Â∫óÂêç„ÇíÈÅ∏Êäû„Åæ„Åü„ÅØÂÖ•Âäõ">
                    <datalist id="store-list"></datalist>
                </div>
                <div class="input-group">
                    <label>ÂïÜÂìÅÂêç</label>
                    <input id="post-item-name" list="item-list" placeholder="ÂïÜÂìÅ„ÇíÈÅ∏Êäû„Åæ„Åü„ÅØÂÖ•Âäõ">
                    <datalist id="item-list"></datalist>
                </div>
                <div class="input-group">
                    <label>‰æ°Ê†º (Á®éÊäú)</label>
                    <input id="post-price" type="number" placeholder="198">
                </div>
                <div class="input-group">
                    <label>ÂÇôËÄÉ</label>
                    <input id="post-note" placeholder="‰æãÔºö10ÂÄãÂÖ•„ÄÅ„Åä‰∏Ä‰∫∫Êßò1ÁÇπÈôê„Çä">
                </div>
                <button id="submit-btn" style="background:#0061A4; color:white; padding:16px; border-radius:999px; border:none; font-weight:bold; margin-top: 10px;" onclick="submitData()">ÊäïÁ®ø„ÇíÈÄÅ‰ø°„Åô„Çã</button>
            </div>
        </div>
    </div>

    <nav>
        <button id="btn-map" class="nav-item active" onclick="showPage('map-page', this)">
            <div class="nav-icon"><span class="material-symbols-outlined">map</span></div><span style="font-size:10px; font-weight:bold;">„Éû„ÉÉ„Éó</span>
        </button>
        <button id="btn-list" class="nav-item" onclick="showPage('list-page', this)">
            <div class="nav-icon"><span class="material-symbols-outlined">format_list_bulleted</span></div><span style="font-size:10px; font-weight:bold;">„É™„Çπ„Éà</span>
        </button>
        <button id="btn-post" class="nav-item" onclick="showPage('post-page', this)">
            <div class="nav-icon"><span class="material-symbols-outlined">add_circle</span></div><span style="font-size:10px; font-weight:bold;">ÊäïÁ®ø</span>
        </button>
    </nav>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsb43W7oGI-uAyoWp19J1Z3WT3L48QW3TdJDIjseaTvLVtAMAfYX-sZNuLK6kuc2j2pbkLZ0I0p6Pp/pub?gid=0&single=true&output=csv';
    const gasUrl = 'https://script.google.com/macros/s/AKfycbz4OHWsfJStoowmEINpTMAXYEWu71AW5e5VDDyBCWTpAg5jznhgyouLjM5C3YEvUDo/exec';

    const fixedItems = [
        "„Åü„Åæ„Åî", "Áâõ‰π≥", "Áâõ„Åì„ÅæËÇâÔºà100gÂçò‰æ°Ôºâ", "Ë±ö„Åì„ÅæËÇâÔºà100gÂçò‰æ°Ôºâ", "È∂è„ÇÇ„ÇÇËÇâÔºà100gÂçò‰æ°Ôºâ",
        "È∂è„ÇÄ„Å≠ËÇâÔºà100gÂçò‰æ°Ôºâ", "„Åï„Åï„ÅøÔºà100gÂçò‰æ°Ôºâ", "È∂èÁöÆÔºà100gÂçò‰æ°Ôºâ", "Á†ÇËÇùÔºà100gÂçò‰æ°Ôºâ",
        "Ë±ö„ÅÇ„ÅÑ„Å≥„Åç„Éü„É≥„ÉÅÔºà100gÂçò‰æ°Ôºâ", "È∂è„ÇÇ„ÇÇ„Éü„É≥„ÉÅÔºà100gÂçò‰æ°Ôºâ", "È∂è„ÇÄ„Å≠„Éü„É≥„ÉÅÔºà100gÂçò‰æ°Ôºâ",
        "Ë±ÜËÖê", "„ÅÇ„Å∂„Çâ„ÅÇ„Åí", "„ÅÜ„Å©„Çì", "Èï∑„Éç„ÇÆ", "„Ç≠„É£„Éô„ÉÑ", "„Å´„Çì„Åò„Çì", "„Åò„ÇÉ„Åå„ÅÑ„ÇÇ", "Áéâ„Å≠„Åé"
    ];

    const categoryColors = { "„Çπ„Éº„Éë„Éº": "#34a853", "„Éâ„É©„ÉÉ„Ç∞„Çπ„Éà„Ç¢": "#d93025", "JA": "#ffa502", "„Éá„Éï„Ç©„É´„Éà": "#0061A4" };
    let map, markers = [], allStoreData = [], currentCategory = "„Åô„Åπ„Å¶";

    function initMap() {
        map = L.map('map', { zoomControl: false, tap: false }).setView([34.7628, 137.3817], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        loadData();
    }

    async function loadData() {
        try {
            const res = await fetch(csvUrl + '&t=' + Date.now());
            const text = await res.text();
            const rows = text.split(/\r?\n/).slice(1);
            
            const pastItemCounts = {};
            allStoreData = rows.map(row => {
                const c = row.split(',');
                const name = c[0];
                const priceInfo = c[6] || "";
                if (priceInfo) {
                    priceInfo.split('/').forEach(p => {
                        const itemName = p.split(':')[0]?.trim();
                        if (itemName) pastItemCounts[itemName] = (pastItemCounts[itemName] || 0) + 1;
                    });
                }
                return { name, lat: parseFloat(c[1]), lng: parseFloat(c[2]), category: c[5] || "Êú™ÂàÜÈ°û", price: priceInfo };
            }).filter(d => !isNaN(d.lat));
            
            const storeDatalist = document.getElementById('store-list');
            const uniqueStoreNames = [...new Set(allStoreData.map(s => s.name))];
            storeDatalist.innerHTML = uniqueStoreNames.map(name => `<option value="${name}">`).join('');

            const pastFrequentItems = Object.keys(pastItemCounts)
                .filter(name => !fixedItems.includes(name))
                .sort((a, b) => pastItemCounts[b] - pastItemCounts[a])
                .slice(0, 10);
            
            const fullItemList = [...fixedItems, ...pastFrequentItems];
            document.getElementById('item-list').innerHTML = fullItemList.map(item => `<option value="${item}">`).join('');

            renderUI();
        } catch (e) { console.error("„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº", e); }
    }

    function renderUI() {
        // Êó¢Â≠ò„ÅÆ„Éû„Éº„Ç´„Éº„ÇíÂâäÈô§
        markers.forEach(m => map.removeLayer(m));
        
        // „Ç´„ÉÜ„Ç¥„É™„ÉÅ„ÉÉ„Éó„ÅÆÁîüÊàê
        const categories = ["„Åô„Åπ„Å¶", ...new Set(allStoreData.map(d => d.category))];
        const chipContainer = document.getElementById('category-chips');
        chipContainer.innerHTML = categories.map(cat => `
            <div onclick="filterByCategory('${cat}')" class="chip ${currentCategory === cat ? 'active' : ''}">${cat}</div>
        `).join('');

        // Êñ∞„Åó„ÅÑ„Éû„Éº„Ç´„Éº„Çí‰ΩúÊàê
        markers = allStoreData.map(s => {
            const color = categoryColors[s.category] || categoryColors["„Éá„Éï„Ç©„É´„Éà"];
            const icon = L.divIcon({
                className: 'custom-icon',
                html: `<div class="custom-pin"><span class="material-symbols-outlined" style="color:${color};font-size:34px;">location_on</span></div>`,
                iconSize: [34, 34], iconAnchor: [17, 34]
            });
            const m = L.marker([s.lat, s.lng], { icon });
            const googleMapUrl = `https://www.google.com/maps/search/?api=1&query=${s.lat},${s.lng}`;
            m.bindPopup(`
                <div style="min-width:150px">
                    <b>${s.name}</b>
                    <div style="color:red;font-weight:bold;margin:5px 0;font-size:13px;">${s.price.replace(/\//g, '<br>')}</div>
                    <div style="display:flex;gap:5px;">
                        <button onclick="openPostWithStore('${s.name}')" style="flex:1;background:#059669;color:white;border:none;padding:8px;border-radius:6px;font-size:10px;font-weight:bold;cursor:pointer;">ÊäïÁ®ø</button>
                        <a href="${googleMapUrl}" target="_blank" style="flex:1;background:#0061A4;color:white;padding:8px;border-radius:6px;font-size:10px;font-weight:bold;text-align:center;text-decoration:none;">üöó Ê°àÂÜÖ</a>
                    </div>
                </div>
            `);
            m.storeData = s;
            return m;
        });

        updateFilters();
    }

    function filterByCategory(cat) {
        currentCategory = cat;
        renderUI();
    }

    function handleSearch(val) {
        const suggest = document.getElementById('search-suggest');
        if (!val) { suggest.style.display = 'none'; updateFilters(); return; }
        const filtered = allStoreData.filter(s => s.name.includes(val) || s.price.includes(val)).slice(0, 10);
        if (filtered.length > 0) {
            suggest.innerHTML = filtered.map(s => `<div class="suggest-item" onclick="jumpToStore('${s.name}', ${s.lat}, ${s.lng})"><span class="suggest-name">${s.name}</span></div>`).join('');
            suggest.style.display = 'block';
        } else { suggest.style.display = 'none'; }
        updateFilters();
    }

    function jumpToStore(name, lat, lng) {
        document.getElementById('search-box').value = name;
        closeSuggest(); 
        showPage('map-page', document.getElementById('btn-map'));
        map.flyTo([lat, lng], 17);
        setTimeout(() => { 
            const target = markers.find(m => m.storeData.name === name);
            if (target) target.openPopup(); 
        }, 500);
    }

    function closeSuggest() { document.getElementById('search-suggest').style.display = 'none'; }

    function updateFilters() {
        const query = document.getElementById('search-box').value.toLowerCase();
        const listContent = document.getElementById('store-list-content');
        listContent.innerHTML = ""; 
        let count = 0;
        
        markers.forEach(m => {
            const s = m.storeData;
            const match = (s.name.toLowerCase().includes(query) || s.price.toLowerCase().includes(query)) && 
                          (currentCategory === "„Åô„Åπ„Å¶" || s.category === currentCategory);
            
            if (match) {
                map.addLayer(m); 
                count++;
                listContent.innerHTML += `
                    <div class="store-card">
                        <div style="padding:12px;border-bottom:1px solid #f1f5f9">
                            <span style="font-size:10px;color:#94a3b8;font-weight:bold;">${s.category}</span>
                            <div style="font-weight:bold;margin-top:2px;">${s.name}</div>
                        </div>
                        <div class="card-price">${s.price.replace(/\//g, '<br>')}</div>
                        <div class="card-btns">
                            <button class="btn" style="background:#eff6ff;color:#0061A4;" onclick="jumpToStore('${s.name}', ${s.lat}, ${s.lng})">üó∫ Âú∞Âõ≥</button>
                            <a class="btn" style="background:#0061A4;color:white;" href="https://www.google.com/maps/search/?api=1&query=${s.lat},${s.lng}" target="_blank">üöó Ê°àÂÜÖ</a>
                        </div>
                    </div>`;
            } else { 
                map.removeLayer(m); 
            }
        });
        document.getElementById('list-count').innerText = `${count}‰ª∂Ë°®Á§∫‰∏≠`;
    }

    function showPage(id, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => { 
            n.classList.remove('active'); 
            n.querySelector('.material-symbols-outlined').style.fontVariationSettings = "'FILL' 0"; 
        });
        btn.classList.add('active'); 
        btn.querySelector('.material-symbols-outlined').style.fontVariationSettings = "'FILL' 1";
        if(id === 'map-page') setTimeout(() => map.invalidateSize(), 200);
    }

    function openPostWithStore(name) { 
        document.getElementById('post-store-name').value = name; 
        showPage('post-page', document.getElementById('btn-post')); 
    }

    async function submitData() {
        const storeName = document.getElementById('post-store-name').value;
        const itemName = document.getElementById('post-item-name').value;
        const price = document.getElementById('post-price').value;
        const note = document.getElementById('post-note').value;
        if (!storeName || !itemName || !price) return alert("ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
        const b = document.getElementById('submit-btn'); 
        b.innerText = "ÈÄÅ‰ø°‰∏≠..."; b.disabled = true;
        try {
            await fetch(gasUrl, { method: "POST", mode: "no-cors", body: JSON.stringify({ storeName, itemName, price, note }) });
            alert("ÊäïÁ®øÂÆå‰∫ÜÔºÅ"); 
            loadData(); 
            showPage('map-page', document.getElementById('btn-map'));
        } catch (e) { alert("„Ç®„É©„Éº"); }
        b.innerText = "ÊäïÁ®ø„ÇíÈÄÅ‰ø°„Åô„Çã"; b.disabled = false;
    }

    function goToMyLocation() { 
        if (navigator.geolocation) { 
            navigator.geolocation.getCurrentPosition(p => map.flyTo([p.coords.latitude, p.coords.longitude], 16)); 
        } 
    }

    window.onload = initMap;
</script>
</body>
</html>
