<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>è±Šæ©‹ãŠè²·ã„ç‰©ãƒãƒƒãƒ—</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="è±Šæ©‹ãƒãƒƒãƒ—">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* --- å…¨ä½“è¨­è¨ˆ --- */
        body { 
            margin: 0; padding: 0; 
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', sans-serif;
            background: #f0f2f5; 
            overflow: hidden; 
            height: 100dvh; 
            display: flex; flex-direction: column; 
            color: #333;
        }

        /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ --- */
        header { 
            background: #ffffff; padding: 12px 15px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            z-index: 6000; flex-shrink: 0;
        }
        .search-container { display: flex; gap: 10px; align-items: center; }
        #search-box { 
            flex: 1; padding: 12px 16px; border-radius: 25px; 
            border: 1px solid #dfe1e5; background: #f1f3f4;
            font-size: 16px; outline: none; transition: all 0.2s;
        }
        #search-box:focus { background: #fff; border-color: #1a73e8; box-shadow: 0 1px 6px rgba(32,33,36,0.28); }
        #menu-toggle { 
            background: #1a73e8; color: #fff; border: none; border-radius: 20px; 
            padding: 8px 16px; font-weight: bold; font-size: 14px; cursor: pointer;
        }

        /* --- çµã‚Šè¾¼ã¿ãƒ¡ãƒ‹ãƒ¥ãƒ¼ --- */
        #menu { 
            position: fixed; top: 70px; right: 15px; z-index: 7000; 
            background: white; width: 260px; padding: 20px; border-radius: 16px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); display: none; 
        }
        #menu.show { display: block; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ --- */
        .page { display: none; flex: 1; width: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .active { display: flex; flex-direction: column; }
        #map { flex: 1; width: 100%; z-index: 1; background: #e5e3df; }
        
        /* --- ãƒ•ãƒƒã‚¿ãƒ¼ --- */
        #footer-nav { 
            height: 70px; background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px); display: flex; border-top: 1px solid #eee;
            z-index: 5000; flex-shrink: 0; padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item { 
            flex: 1; display: flex; flex-direction: column; align-items: center; 
            justify-content: center; font-size: 10px; color: #5f6368; 
            cursor: pointer; border: none; background: none; 
        }
        .nav-item.active-nav { color: #1a73e8; font-weight: bold; }
        .nav-icon { font-size: 22px; margin-bottom: 4px; }

        /* --- ã‚«ãƒ¼ãƒ‰ã¨ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
        .list-container { padding: 16px; }
        .store-card { 
            background: white; padding: 20px; border-radius: 16px; 
            margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        }
        .store-name { font-size: 18px; font-weight: bold; margin-bottom: 4px; }
        .category-tag { 
            display: inline-block; padding: 4px 10px; border-radius: 12px; 
            font-size: 11px; font-weight: bold; color: white; margin-bottom: 10px; 
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; color: #5f6368; }
        .form-group input, .form-group textarea { 
            width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #ddd; 
            box-sizing: border-box; font-size: 16px; background: #f8f9fa;
        }
        .post-btn { 
            background: #1a73e8; color: white; border: none; padding: 16px; 
            border-radius: 12px; font-weight: bold; width: 100%; font-size: 16px;
        }

        /* --- åœ°å›³ä¸Šã®ãƒ‘ãƒ¼ãƒ„ --- */
        .location-btn { 
            position: absolute; bottom: 30px; right: 20px; z-index: 1000; 
            background: white; border-radius: 50%; width: 56px; height: 56px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); color: #1a73e8;
        }
        .popup-post-btn { background: #34a853; color: white !important; border: none; padding: 10px; border-radius: 8px; width: 100%; font-weight: bold; margin-top: 10px; cursor: pointer; text-decoration: none; display: block; text-align: center; }
        .route-btn { display: block; margin-top: 8px; padding: 10px; background: #f1f3f4; color: #1a73e8 !important; text-align: center; text-decoration: none; border-radius: 8px; font-weight: bold; }
    </style>
</head>
<body>

<header>
    <div class="search-container">
        <input type="text" id="search-box" placeholder="åº—åã‚„å•†å“ã§æ¤œç´¢..." oninput="updateFilters()">
        <button id="menu-toggle" onclick="toggleMenu()">ğŸ” çµè¾¼</button>
    </div>
</header>

<div id="menu">
    <strong>ã‚«ãƒ†ã‚´ãƒªã§çµã‚Šè¾¼ã¿</strong><hr>
    <div id="category-filters" style="max-height:250px; overflow-y:auto;"></div>
</div>

<div id="map-page" class="page active">
    <div id="map"></div>
    <div class="location-btn" onclick="goToMyLocation()">ğŸ“</div>
</div>

<div id="list-page" class="page">
    <div class="list-container">
        <h3 id="list-title">ğŸ“‹ åº—èˆ—ãƒ»åº•å€¤ä¸€è¦§</h3>
        <div id="store-list-content"></div>
    </div>
</div>

<div id="post-page" class="page">
    <div style="padding: 20px; max-width: 500px; margin: 0 auto; width: 100%; box-sizing: border-box;">
        <h2 style="text-align:center;">ğŸ’° æƒ…å ±æŠ•ç¨¿</h2>
        <div style="background:white; padding:20px; border-radius:15px; box-shadow:0 4px 10px rgba(0,0,0,0.1);">
            <div class="form-group">
                <label>åº—å</label>
                <input type="text" id="post-store-name" placeholder="ãƒãƒƒãƒ—ã‹ã‚‰é¸æŠã™ã‚‹ã‹å…¥åŠ›">
            </div>
            <div class="form-group">
                <label>å•†å“å</label>
                <input type="text" id="post-item-name" placeholder="ä¾‹ï¼šãŸã¾ã”">
            </div>
            <div class="form-group">
                <label>ä¾¡æ ¼</label>
                <input type="text" id="post-price" placeholder="ä¾‹ï¼š198å††">
            </div>
            <div class="form-group">
                <label>å‚™è€ƒï¼ˆä»»æ„ï¼‰</label>
                <textarea id="post-memo" placeholder="ã‚»ãƒ¼ãƒ«ã®æƒ…å ±ãªã©"></textarea>
            </div>
            <button onclick="submitData()" id="submit-btn" class="post-btn">æŠ•ç¨¿ã™ã‚‹</button>
        </div>
    </div>
</div>

<nav id="footer-nav">
    <button class="nav-item active-nav" onclick="showPage('map-page', this)">
        <span class="nav-icon">ğŸ—ºï¸</span>åœ°å›³
    </button>
    <button class="nav-item" onclick="showPage('list-page', this)">
        <span class="nav-icon">ğŸ“‹</span>ä¸€è¦§
    </button>
    <button class="nav-item" onclick="showPage('post-page', this)">
        <span class="nav-icon">â•</span>æŠ•ç¨¿
    </button>
</nav>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsb43W7oGI-uAyoWp19J1Z3WT3L48QW3TdJDIjseaTvLVtAMAfYX-sZNuLK6kuc2j2pbkLZ0I0p6Pp/pub?gid=0&single=true&output=csv';
    const gasUrl = 'https://script.google.com/macros/s/AKfycbz4OHWsfJStoowmEINpTMAXYEWu71AW5e5VDDyBCWTpAg5jznhgyouLjM5C3YEvUDo/exec';

    const categoryColors = {
        "ã‚¹ãƒ¼ãƒ‘ãƒ¼": "#ff4757", "æ¥­å‹™ã‚¹ãƒ¼ãƒ‘ãƒ¼": "#2f3542", "ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢": "#2ed573",
        "JA": "#ffa502", "ç›´è²©æ‰€": "#7bed9f", "å…«ç™¾å±‹": "#ff6348", "æœç‰©å±‹": "#eccc68",
        "é­šå±‹": "#1e90ff", "ãƒ–ãƒ©ã‚¸ãƒ«é£Ÿå“": "#3742fa", "ãƒ™ãƒˆãƒŠãƒ é£Ÿå“": "#ff7f50", "é£Ÿå“å€‰åº«": "#a4b0be"
    };

    let markers = [];
    let allStoreData = [];
    const map = L.map('map', { zoomControl: false }).setView([34.7628, 137.3817], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    function csvToArray(str) {
        const result = [];
        const rows = str.split(/\r?\n/);
        rows.forEach(row => {
            const cols = [];
            let current = ""; let inQuotes = false;
            for (let i = 0; i < row.length; i++) {
                const c = row[i];
                if (c === '"') inQuotes = !inQuotes;
                else if (c === ',' && !inQuotes) { cols.push(current); current = ""; }
                else current += c;
            }
            cols.push(current);
            result.push(cols);
        });
        return result;
    }

    async function loadData() {
        try {
            const response = await fetch(csvUrl + '&t=' + new Date().getTime());
            const csvText = await response.text();
            const data = csvToArray(csvText.trim());
            const rows = data.slice(1);

            allStoreData = rows.map(cols => {
                const lat = parseFloat(cols[1]?.toString().replace(/[^0-9.]/g, ''));
                const lng = parseFloat(cols[2]?.toString().replace(/[^0-9.]/g, ''));
                if (isNaN(lat) || isNaN(lng)) return null;
                return {
                    name: (cols[0] || "").replace(/"/g, "").trim(),
                    lat: lat, lng: lng,
                    info1: cols[3] || "", info2: cols[4] || "",
                    category: (cols[5] || "æœªåˆ†é¡").trim(), price: cols[6] || ""
                };
            }).filter(d => d !== null);

            createMarkers();
            setupCategoryMenu();
            updateFilters();
        } catch (e) { console.error(e); }
    }

    function createMarkers() {
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        allStoreData.forEach(store => {
            const color = categoryColors[store.category] || "#747d8c";
            const marker = L.circleMarker([store.lat, store.lng], {
                radius: 12, fillColor: color, color: "#fff", weight: 2, fillOpacity: 0.9
            });
            const priceHtml = store.price ? `<div style="margin-top:8px; padding:10px; background:#fffdf0; border-radius:6px; font-size:12px; border:1px solid #ffeaa7;">${store.price.split('/').join('<br>')}</div>` : "";
            const popupContent = `
                <div style="min-width:160px;">
                    <strong>${store.name}</strong><br><small>${store.category}</small>
                    ${priceHtml}
                    <button class="popup-post-btn" onclick="openPostWithStore('${store.name}')">ğŸ’° ä¾¡æ ¼ã‚’å ±å‘Š</button>
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${store.lat},${store.lng}" target="_blank" class="route-btn">ğŸš— ãƒ«ãƒ¼ãƒˆæ¡ˆå†…</a>
                </div>`;
            marker.bindPopup(popupContent);
            marker.storeData = store;
            markers.push(marker);
            marker.addTo(map);
        });
    }

    function updateFilters() {
        const searchText = document.getElementById('search-box').value.toLowerCase();
        const checkboxes = document.querySelectorAll('.cat-check');
        const checkedCats = checkboxes.length > 0 
            ? Array.from(document.querySelectorAll('.cat-check:checked')).map(i => i.value)
            : Object.keys(categoryColors);

        const listContent = document.getElementById('store-list-content');
        listContent.innerHTML = '';

        const matched = [];
        markers.forEach(m => {
            const isMatch = m.storeData.name.toLowerCase().includes(searchText) || m.storeData.price.toLowerCase().includes(searchText);
            const isCatMatch = checkedCats.includes(m.storeData.category);
            if (isMatch && isCatMatch) { map.addLayer(m); } else { map.removeLayer(m); }
        });

        allStoreData.forEach(store => {
            if (checkedCats.includes(store.category)) {
                if (store.name.toLowerCase().includes(searchText) || store.price.toLowerCase().includes(searchText)) {
                    const color = categoryColors[store.category] || "#747d8c";
                    const card = document.createElement('div');
                    card.className = 'store-card';
                    card.innerHTML = `<div class="store-name">${store.name}</div><div class="category-tag" style="background:${color}">${store.category}</div><div style="font-size:12px; color:#666;">${store.info1}</div><div style="margin-top:8px; font-size:13px; color:#d63031; font-weight:bold;">${store.price || ""}</div><button onclick="openPostWithStore('${store.name}')" style="margin-top:10px; border:1px solid #1a73e8; color:#1a73e8; background:none; padding:8px; border-radius:5px; width:100%; font-weight:bold;">ğŸ’° ä¾¡æ ¼ã‚’å ±å‘Š</button>`;
                    listContent.appendChild(card);
                }
            }
        });
    }

    function setupCategoryMenu() {
        const cats = [...new Set(allStoreData.map(d => d.category))];
        const container = document.getElementById('category-filters');
        container.innerHTML = '<label style="display:block;margin:10px 0;"><input type="checkbox" id="all-select" checked> (ã™ã¹ã¦é¸æŠ)</label>';
        cats.sort().forEach(cat => {
            const label = document.createElement('label');
            label.style.display = "block"; label.style.marginBottom = "8px";
            label.innerHTML = `<input type="checkbox" class="cat-check" checked value="${cat}"> ${cat}`;
            container.appendChild(label);
        });
        document.getElementById('all-select').addEventListener('change', function() {
            document.querySelectorAll('.cat-check').forEach(c => c.checked = this.checked);
            updateFilters();
        });
        document.querySelectorAll('.cat-check').forEach(c => c.addEventListener('change', updateFilters));
    }

    function openPostWithStore(storeName) {
        document.getElementById('post-store-name').value = storeName;
        showPage('post-page', document.querySelectorAll('.nav-item')[2]);
    }

    function showPage(pageId, elm) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active-nav'));
        elm.classList.add('active-nav');
        if(pageId === 'map-page') { setTimeout(() => { map.invalidateSize(); }, 100); }
    }

    function toggleMenu() { document.getElementById('menu').classList.toggle('show'); }

    function goToMyLocation() {
        navigator.geolocation.getCurrentPosition(pos => {
            const latlng = [pos.coords.latitude, pos.coords.longitude];
            L.circleMarker(latlng, { radius: 8, color: '#1a73e8', fillColor: '#1a73e8', fillOpacity: 0.8 }).addTo(map).bindPopup("ç¾åœ¨åœ°");
            map.flyTo(latlng, 16);
        }, err => alert("ä½ç½®æƒ…å ±ã‚’ã‚ªãƒ³ã«ã—ã¦ãã ã•ã„"));
    }

    async function submitData() {
        const storeName = document.getElementById('post-store-name').value;
        const itemName = document.getElementById('post-item-name').value;
        const price = document.getElementById('post-price').value;
        const memo = document.getElementById('post-memo').value;
        if (!storeName || !itemName || !price) { alert("å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
        const btn = document.getElementById('submit-btn');
        btn.innerText = "é€ä¿¡ä¸­..."; btn.disabled = true;
        try {
            await fetch(gasUrl, { method: "POST", mode: "no-cors", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ storeName, itemName, price, memo }) });
            alert("æŠ•ç¨¿å®Œäº†ï¼åæ˜ ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚");
            showPage('map-page', document.querySelectorAll('.nav-item')[0]);
        } catch (e) { alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"); }
        finally { btn.innerText = "æŠ•ç¨¿ã™ã‚‹"; btn.disabled = false; }
    }

    loadData();
</script>
</body>
</html>
